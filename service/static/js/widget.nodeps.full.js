(function($){$.fn.bindWithDelay=function(type,data,fn,timeout,throttle){var wait=null;var that=this;if($.isFunction(data)){throttle=timeout;timeout=fn;fn=data;data=undefined}function cb(){var e=$.extend(true,{},arguments[0]);var throttler=function(){wait=null;fn.apply(that,[e])};if(!throttle){clearTimeout(wait)}if(!throttle||!wait){wait=setTimeout(throttler,timeout)}}return this.bind(type,data,cb)}})(jQuery);
var es={specialChars:["\\","+","-","=","&&","||",">","<","!","(",")","{","}","[","]","^",'"',"~","*","?",":","/"],specialCharsSubSet:["\\","+","-","=","&&","||",">","<","!","(",")","{","}","[","]","^","~","?",":","/"],characterPairs:['"'],distanceUnits:["km","mi","miles","in","inch","yd","yards","kilometers","mm","millimeters","cm","centimeters","m","meters"],requestMethod:"get",aggregationFactory:function(type,params){var constructors={terms:es.newTermsAggregation,range:es.newRangeAggregation,geo_distance:es.newGeoDistanceAggregation,date_histogram:es.newDateHistogramAggregation,stats:es.newStatsAggregation,cardinality:es.newCardinalityAggregation};if(constructors[type]){return constructors[type](params)}},filterFactory:function(type,params){var constructors={query_string:es.newQueryString,term:es.newTermFilter,terms:es.newTermsFilter,range:es.newRangeFilter,geo_distance_range:es.newGeoDistanceRangeFilter};if(constructors[type]){return constructors[type](params)}},newQuery:function(params){if(!params){params={}}return new es.Query(params)},Query:function(params){this.filtered=params.filtered||true;this.size=params.size!==undefined?params.size:false;this.from=params.from||false;this.fields=params.fields||[];this.aggs=params.aggs||[];this.must=params.must||[];this.queryString=false;this.sort=[];this.source=params.source||false;this.should=params.should||[];this.mustNot=params.mustNot||[];this.partialFields=params.partialFields||false;this.scriptFields=params.scriptFields||false;this.minimumShouldMatch=params.minimumShouldMatch||false;this.partialFields=params.partialFields||false;this.scriptFields=params.scriptFields||false;this.facets=params.facets||[];this.getSize=function(){if(this.size!==undefined&&this.size!==false){return this.size}return 10};this.getFrom=function(){if(this.from){return this.from}return 0};this.addField=function(field){if($.inArray(field,this.fields)===-1){this.fields.push(field)}};this.setQueryString=function(params){var qs=params;if(!(params instanceof es.QueryString)){if($.isPlainObject(params)){qs=es.newQueryString(params)}else{qs=es.newQueryString({queryString:params})}}this.queryString=qs};this.getQueryString=function(){return this.queryString};this.removeQueryString=function(){this.queryString=false};this.setSortBy=function(params){this.sort=[];var sorts=params;if(!$.isArray(params)){sorts=[params]}for(var i=0;i<sorts.length;i++){this.addSortBy(sorts[i])}};this.addSortBy=function(params){var sort=params;if(!(params instanceof es.Sort)){sort=es.newSort(params)}for(var i=0;i<this.sort.length;i++){var so=this.sort[i];if(so.field===sort.field){return}}this.sort.push(sort)};this.prependSortBy=function(params){var sort=params;if(!(params instanceof es.Sort)){sort=es.newSort(params)}this.removeSortBy(sort);this.sort.unshift(sort)};this.removeSortBy=function(params){var sort=params;if(!(params instanceof es.Sort)){sort=es.newSort(params)}var removes=[];for(var i=0;i<this.sort.length;i++){var so=this.sort[i];if(so.field===sort.field){removes.push(i)}}removes=removes.sort().reverse();for(var i=0;i<removes.length;i++){this.sort.splice(removes[i],1)}};this.getSortBy=function(){return this.sort};this.setSourceFilters=function(params){if(!this.source){this.source={include:[],exclude:[]}}if(params.include){this.source.include=params.include}if(params.exclude){this.source.exclude=params.exclude}};this.addSourceFilters=function(params){if(!this.source){this.source={include:[],exclude:[]}}if(params.include){if(this.source.include){Array.prototype.push.apply(this.source.include,params.include)}else{this.source.include=params.include}}if(params.exclude){if(this.source.include){Array.prototype.push.apply(this.source.include,params.include)}else{this.source.include=params.include}}};this.getSourceIncludes=function(){if(!this.source){return[]}return this.source.include};this.getSourceExcludes=function(){if(!this.source){return[]}return this.source.exclude};this.addFacet=function(){};this.removeFacet=function(){};this.clearFacets=function(){};this.getAggregation=function(params){var name=params.name;for(var i=0;i<this.aggs.length;i++){var a=this.aggs[i];if(a.name===name){return a}}};this.addAggregation=function(agg,overwrite){if(overwrite){this.removeAggregation(agg.name)}else{for(var i=0;i<this.aggs.length;i++){if(this.aggs[i].name===agg.name){return}}}this.aggs.push(agg)};this.removeAggregation=function(name){var removes=[];for(var i=0;i<this.aggs.length;i++){if(this.aggs[i].name===name){removes.push(i)}}removes=removes.sort().reverse();for(var i=0;i<removes.length;i++){this.aggs.splice(removes[i],1)}};this.clearAggregations=function(){this.aggs=[]};this.listAggregations=function(){return this.aggs};this.addMust=function(filter){var existing=this.listMust(filter);if(existing.length===0){this.must.push(filter)}};this.listMust=function(template){return this.listFilters({boolType:"must",template:template})};this.removeMust=function(template){var removes=[];for(var i=0;i<this.must.length;i++){var m=this.must[i];if(m.matches(template)){removes.push(i)}}removes=removes.sort().reverse();for(var i=0;i<removes.length;i++){this.must.splice(removes[i],1)}return removes.length};this.clearMust=function(){};this.addShould=function(){};this.listShould=function(){};this.removeShould=function(){};this.clearShould=function(){};this.addMustNot=function(){};this.listMustNot=function(){};this.removeMustNot=function(){};this.removeMustNot=function(){};this.hasFilters=function(){return this.must.length>0||this.should.length>0||this.mustNot.length>0};this.listFilters=function(params){var boolType=params.boolType||"must";var template=params.template||false;var bool=[];if(boolType==="must"){bool=this.must}else if(boolType==="should"){bool=this.should}else if(boolType==="must_not"){bool=this.mustNot}if(!template){return bool}var l=[];for(var i=0;i<bool.length;i++){var m=bool[i];if(m.matches(template)){l.push(m)}}return l};this.merge=function(source){this.filtered=source.filtered;if(source.size){this.size=source.size}if(source.from){this.from=source.from}if(source.fields&&source.fields.length>0){for(var i=0;i<source.fields.length;i++){this.addField(source.fields[i])}}var aggs=source.listAggregations();for(var i=0;i<aggs.length;i++){this.addAggregation(aggs[i],true)}var must=source.listMust();for(var i=0;i<must.length;i++){this.addMust(must[i])}if(source.getQueryString()){this.setQueryString(source.getQueryString())}var sorts=source.getSortBy();if(sorts&&sorts.length>0){sorts.reverse();for(var i=0;i<sorts.length;i++){this.prependSortBy(sorts[i])}}var includes=source.getSourceIncludes();var excludes=source.getSourceExcludes();this.addSourceFilters({include:includes,exclude:excludes})};this.objectify=function(params){if(!params){params={}}var include_query_string=params.include_query_string===undefined?true:params.include_query_string;var include_filters=params.include_filters===undefined?true:params.include_filters;var include_paging=params.include_paging===undefined?true:params.include_paging;var include_sort=params.include_sort===undefined?true:params.include_sort;var include_fields=params.include_fields===undefined?true:params.include_fields;var include_aggregations=params.include_aggregations===undefined?true:params.include_aggregations;var include_source_filters=params.include_source_filters===undefined?true:params.include_source_filters;var q={};var query_part={};var bool={};if(this.queryString&&include_query_string){$.extend(query_part,this.queryString.objectify())}if(include_filters){if(this.must.length>0){var musts=[];for(var i=0;i<this.must.length;i++){var m=this.must[i];musts.push(m.objectify())}bool["must"]=musts}}if(this.filtered&&this.hasFilters()){if(Object.keys(query_part).length==0){query_part["match_all"]={}}q["query"]={filtered:{filter:{bool:bool},query:query_part}}}else{if(this.hasFilters()){query_part["bool"]=bool}if(Object.keys(query_part).length==0){query_part["match_all"]={}}q["query"]=query_part}if(include_paging){if(this.size!==undefined&&this.size!==false){q["size"]=this.size}if(this.from){q["from"]=this.from}}if(this.sort.length>0&&include_sort){q["sort"]=[];for(var i=0;i<this.sort.length;i++){q.sort.push(this.sort[i].objectify())}}if(this.fields.length>0&&include_fields){q["fields"]=this.fields}if(this.aggs.length>0&&include_aggregations){q["aggs"]={};for(var i=0;i<this.aggs.length;i++){var agg=this.aggs[i];$.extend(q.aggs,agg.objectify())}}if(include_source_filters&&this.source&&(this.source.include||this.source.exclude)){q["_source"]={};if(this.source.include.length>0){q["_source"]["include"]=this.source.include}if(this.source.exclude.length>0){q["_source"]["exclude"]=this.source.exclude}}return q};es.Query.prototype.toString=function queryToString(){return JSON.stringify(this.objectify())};this.parse=function(obj){function parseBool(bool,target){if(bool.must){for(var i=0;i<bool.must.length;i++){var type=Object.keys(bool.must[i])[0];var fil=es.filterFactory(type,{raw:bool.must[i]});if(fil){target.addMust(fil)}}}}function parseQuery(q,target){var keys=Object.keys(q);for(var i=0;i<keys.length;i++){var type=keys[i];var impl=es.filterFactory(type,{raw:q[type]});if(impl){if(type==="query_string"){target.setQueryString(impl)}}}}if(obj.query){if(obj.query.filtered){this.filtered=true;var bool=obj.query.filtered.filter.bool;if(bool){parseBool(bool,this)}var q=obj.query.filtered.query;parseQuery(q,this)}else{var q=obj.query;parseQuery(q,this)}}if(obj.size){this.size=obj.size}if(obj.from){this.from=obj.from}if(obj.fields){this.fields=obj.fields}if(obj.sort){for(var i=0;i<obj.sort.length;i++){var so=obj.sort[i];this.addSortBy(es.newSort({raw:so}))}}if(obj.aggs||obj.aggregations){var aggs=obj.aggs?obj.aggs:obj.aggregations;var anames=Object.keys(aggs);for(var i=0;i<anames.length;i++){var name=anames[i];var agg=aggs[name];var type=Object.keys(agg)[0];var raw={};raw[name]=agg;var oa=es.aggregationFactory(type,{raw:raw});if(oa){this.addAggregation(oa)}}}if(obj._source){var source=obj._source;var include=[];var exclude=[];if(typeof source==="string"){include.push(source)}else if(Array.isArray(source)){include=source}else{if(source.hasOwnProperty("include")){include=source.include}if(source.hasOwnProperty("exclude")){exclude=source.exclude}}this.setSourceFilters({include:include,exclude:exclude})}};if(params.queryString){this.setQueryString(params.queryString)}if(params.sort){this.setSortBy(params.sort)}if(params.raw){this.parse(params.raw)}},newQueryString:function(params){if(!params){params={}}return new es.QueryString(params)},QueryString:function(params){this.queryString=params.queryString||false;this.defaultField=params.defaultField||false;this.defaultOperator=params.defaultOperator||"OR";this.fuzzify=params.fuzzify||false;this.escapeSet=params.escapeSet||es.specialCharsSubSet;this.pairs=params.pairs||es.characterPairs;this.unEscapeSet=params.unEscapeSet||es.specialChars;this.objectify=function(){var qs=this._escape(this._fuzzify(this.queryString));var obj={query_string:{query:qs}};if(this.defaultOperator){obj.query_string["default_operator"]=this.defaultOperator}if(this.defaultField){obj.query_string["default_field"]=this.defaultField}return obj};this.parse=function(obj){if(obj.query_string){obj=obj.query_string}this.queryString=this._unescape(obj.query);if(obj.default_operator){this.defaultOperator=obj.default_operator}if(obj.default_field){this.defaultField=obj.default_field}};this._fuzzify=function(str){if(!this.fuzzify||!(this.fuzzify==="*"||this.fuzzify==="~")){return str}if(!(str.indexOf("*")===-1&&str.indexOf("~")===-1&&str.indexOf(":")===-1)){return str}var pq="";var optparts=str.split(" ");for(var i=0;i<optparts.length;i++){var oip=optparts[i];if(oip.length>0){oip=oip+this.fuzzify;this.fuzzify=="*"?oip="*"+oip:false;pq+=oip+" "}}return pq};this._escapeRegExp=function(string){return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")};this._replaceAll=function(string,find,replace){return string.replace(new RegExp(this._escapeRegExp(find),"g"),replace)};this._unReplaceAll=function(string,find){return string.replace(new RegExp("\\\\("+this._escapeRegExp(find)+")","g"),"$1")};this._paired=function(string,pair){var matches=string.match(new RegExp(this._escapeRegExp(pair),"g"))||[];return matches.length%2===0};this._escape=function(str){var scs=this.escapeSet.slice(0);for(var i=0;i<this.pairs.length;i++){var char=this.pairs[i];if(!this._paired(str,char)){scs.push(char)}}for(var i=0;i<scs.length;i++){var char=scs[i];str=this._replaceAll(str,char,"\\"+char)}return str};this._unescape=function(str){for(var i=0;i<this.unEscapeSet.length;i++){var char=this.unEscapeSet[i];str=this._unReplaceAll(str,char)}return str};if(params.raw){this.parse(params.raw)}},newSort:function(params){if(!params){params={}}return new es.Sort(params)},Sort:function(params){this.field=params.field||"_score";this.order=params.order||"desc";this.objectify=function(){var obj={};obj[this.field]={order:this.order};return obj};this.parse=function(obj){this.field=Object.keys(obj)[0];if(obj[this.field].order){this.order=obj[this.field].order}};if(params.raw){this.parse(params.raw)}},newAggregation:function(params){if(!params){params={}}return new es.Aggregation(params)},Aggregation:function(params){this.name=params.name;this.aggs=params.aggs||[];this.addAggregation=function(agg){for(var i=0;i<this.aggs.length;i++){if(this.aggs[i].name===agg.name){return}}this.aggs.push(agg)};this.removeAggregation=function(){};this.clearAggregations=function(){};this._make_aggregation=function(type,body){var obj={};obj[this.name]={};obj[this.name][type]=body;if(this.aggs.length>0){obj[this.name]["aggs"]={};for(var i=0;i<this.aggs.length;i++){$.extend(obj[this.name]["aggs"],this.aggs[i].objectify())}}return obj};this._parse_wrapper=function(obj,type){this.name=Object.keys(obj)[0];var body=obj[this.name][type];var aggs=obj[this.name].aggs?obj[this.name].aggs:obj[this.name].aggregations;if(aggs){var anames=Object.keys(aggs);for(var i=0;i<anames.length;i++){var name=anames[i];var agg=aggs[anames[i]];var subtype=Object.keys(agg)[0];var raw={};raw[name]=agg;var oa=es.aggregationFactory(subtype,{raw:raw});if(oa){this.addAggregation(oa)}}}return body}},newTermsAggregation:function(params){if(!params){params={}}es.TermsAggregation.prototype=es.newAggregation(params);return new es.TermsAggregation(params)},TermsAggregation:function(params){this.field=params.field||false;this.size=params.size||10;this.orderBy="_count";if(params.orderBy){this.orderBy=params.orderBy;if(this.orderBy[0]!=="_"){this.orderBy="_"+this.orderBy}}this.orderDir=params.orderDir||"desc";this.setOrdering=function(orderBy,orderDir){this.orderBy=orderBy;if(this.orderBy[0]!=="_"){this.orderBy="_"+this.orderBy}this.orderDir=orderDir};this.objectify=function(){var body={field:this.field,size:this.size,order:{}};body.order[this.orderBy]=this.orderDir;return this._make_aggregation("terms",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"terms");this.field=body.field;if(body.size){this.size=body.size}if(body.order){this.orderBy=Object.keys(body.order)[0];this.orderDir=body.order[this.orderBy]}};if(params.raw){this.parse(params.raw)}},newCardinalityAggregation:function(params){if(!params){params={}}es.CardinalityAggregation.prototype=es.newAggregation(params);return new es.CardinalityAggregation(params)},CardinalityAggregation:function(params){this.field=es.getParam(params.field,false);this.objectify=function(){var body={field:this.field};return this._make_aggregation("cardinality",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"cardinality");this.field=body.field};if(params.raw){this.parse(params.raw)}},newRangeAggregation:function(params){if(!params){params={}}es.RangeAggregation.prototype=es.newAggregation(params);return new es.RangeAggregation(params)},RangeAggregation:function(params){this.field=params.field||false;this.ranges=params.ranges||[];this.objectify=function(){var body={field:this.field,ranges:this.ranges};return this._make_aggregation("range",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"range");this.field=body.field;this.ranges=body.ranges};if(params.raw){this.parse(params.raw)}},newGeoDistanceAggregation:function(params){if(!params){params={}}es.GeoDistanceAggregation.prototype=es.newAggregation(params);return new es.GeoDistanceAggregation(params)},GeoDistanceAggregation:function(params){this.field=params.field||false;this.lat=params.lat||false;this.lon=params.lon||false;this.unit=params.unit||"m";this.distance_type=params.distance_type||"sloppy_arc";this.ranges=params.ranges||[];this.objectify=function(){var body={field:this.field,origin:{lat:this.lat,lon:this.lon},unit:this.unit,distance_type:this.distance_type,ranges:this.ranges};return this._make_aggregation("geo_distance",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"range");this.field=body.field;var origin=body.origin;if(origin.lat){this.lat=origin.lat}if(origin.lon){this.lon=origin.lon}if(body.unit){this.unit=body.unit}if(body.distance_type){this.distance_type=body.distance_type}this.ranges=body.ranges};if(params.raw){this.parse(params.raw)}},newStatsAggregation:function(params){if(!params){params={}}es.StatsAggregation.prototype=es.newAggregation(params);return new es.StatsAggregation(params)},StatsAggregation:function(params){this.field=params.field||false;this.objectify=function(){var body={field:this.field};return this._make_aggregation("stats",body)};this.parse=function(obj){};if(params.raw){this.parse(params.raw)}},newSumAggregation:function(params){if(!params){params={}}es.SumAggregation.prototype=es.newAggregation(params);return new es.SumAggregation(params)},SumAggregation:function(params){this.field=params.field||false;this.objectify=function(){var body={field:this.field};return this._make_aggregation("sum",body)};this.parse=function(obj){};if(params.raw){this.parse(params.raw)}},newDateHistogramAggregation:function(params){if(!params){params={}}es.DateHistogramAggregation.prototype=es.newAggregation(params);return new es.DateHistogramAggregation(params)},DateHistogramAggregation:function(params){this.field=params.field||false;this.interval=params.interval||"month";this.format=params.format||false;this.objectify=function(){var body={field:this.field,interval:this.interval};if(this.format){body["format"]=this.format}return this._make_aggregation("date_histogram",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"date_histogram");this.field=body.field;if(body.interval){this.interval=body.interval}if(body.format){this.format=body.format}};if(params.raw){this.parse(params.raw)}},newFilter:function(params){if(!params){params={}}return new es.Filter(params)},Filter:function(params){this.field=params.field;this.type_name=params.type_name;this.matches=function(other){if(other.type_name!==this.type_name){return false}if(other.field&&other.field!==this.field){return false}return true};this.objectify=function(){};this.parse=function(){}},newTermFilter:function(params){if(!params){params={}}params.type_name="term";es.TermFilter.prototype=es.newFilter(params);return new es.TermFilter(params)},TermFilter:function(params){this.value=params.value||false;this.matches=function(other){var pm=Object.getPrototypeOf(this).matches.call(this,other);if(!pm){return false}if(other.value&&other.value!==this.value){return false}return true};this.objectify=function(){var obj={term:{}};obj.term[this.field]=this.value;return obj};this.parse=function(obj){if(obj.term){obj=obj.term}this.field=Object.keys(obj)[0];this.value=obj[this.field]};if(params.raw){this.parse(params.raw)}},newTermsFilter:function(params){if(!params){params={}}params.type_name="terms";es.TermsFilter.prototype=es.newFilter(params);return new es.TermsFilter(params)},TermsFilter:function(params){this.values=params.values||false;this.execution=params.execution||false;this.matches=function(other){var pm=Object.getPrototypeOf(this).matches.call(this,other);if(!pm){return false}if(other.values){if(other.values.length!==this.values.length){return false}for(var i=0;i<other.values.length;i++){if($.inArray(other.values[i],this.values)===-1){return false}}}return true};this.objectify=function(){var val=this.values||[];var obj={terms:{}};obj.terms[this.field]=val;if(this.execution){obj.terms["execution"]=this.execution}return obj};this.parse=function(obj){if(obj.terms){obj=obj.terms}this.field=Object.keys(obj)[0];this.values=obj[this.field];if(obj.execution){this.execution=obj.execution}};this.add_term=function(term){if(!this.values){this.values=[]}if($.inArray(term,this.values)===-1){this.values.push(term)}};this.has_term=function(term){if(!this.values){return false}return $.inArray(term,this.values)>=0};this.remove_term=function(term){if(!this.values){return}var idx=$.inArray(term,this.values);if(idx>=0){this.values.splice(idx,1)}};this.has_terms=function(){return this.values!==false&&this.values.length>0};this.term_count=function(){return this.values===false?0:this.values.length};this.clear_terms=function(){this.values=false};if(params.raw){this.parse(params.raw)}},newRangeFilter:function(params){if(!params){params={}}params.type_name="range";es.RangeFilter.prototype=es.newFilter(params);return new es.RangeFilter(params)},RangeFilter:function(params){this.lt=es.getParam(params.lt,false);this.lte=es.getParam(params.lte,false);this.gte=es.getParam(params.gte,false);this.matches=function(other){var pm=Object.getPrototypeOf(this).matches.call(this,other);if(!pm){return false}if(other.lt){if(other.lt!==this.lt){return false}}if(other.lte){if(other.lte!==this.lte){return false}}if(other.gte){if(other.gte!==this.gte){return false}}return true};this.objectify=function(){var obj={range:{}};obj.range[this.field]={};if(this.lte!==false){obj.range[this.field]["lte"]=this.lte}if(this.lt!==false&&this.lte===false){obj.range[this.field]["lt"]=this.lt}if(this.gte!==false){obj.range[this.field]["gte"]=this.gte}return obj};this.parse=function(obj){if(obj.range){obj=obj.range}this.field=Object.keys(obj)[0];if(obj[this.field].lte!==undefined&&obj[this.field].lte!==false){this.lte=obj[this.field].lte}if(obj[this.field].lt!==undefined&&obj[this.field].lt!==false){this.lt=obj[this.field].lt}if(obj[this.field].gte!==undefined&&obj[this.field].gte!==false){this.gte=obj[this.field].gte}};if(params.raw){this.parse(params.raw)}},newGeoDistanceRangeFilter:function(params){if(!params){params={}}params.type_name="geo_distance_range";es.GeoDistanceRangeFilter.prototype=es.newFilter(params);return new es.GeoDistanceRangeFilter(params)},GeoDistanceRangeFilter:function(params){this.lt=params.lt||false;this.gte=params.gte||false;this.lat=params.lat||false;this.lon=params.lon||false;this.unit=params.unit||"m";this.objectify=function(){var obj={geo_distance_range:{}};obj.geo_distance_range[this.field]={lat:this.lat,lon:this.lon};if(this.lt){obj.geo_distance_range["lt"]=this.lt+this.unit}if(this.gte){obj.geo_distance_range["gte"]=this.gte+this.unit}return obj};this.parse=function(obj){function endsWith(str,suffix){return str.indexOf(suffix,str.length-suffix.length)!==-1}function splitUnits(str){var unit=false;for(var i=0;i<es.distanceUnits.length;i++){var cu=es.distanceUnits[i];if(endsWith(str,cu)){str=str.substring(0,str.length-cu.length);unit=str.substring(str.length-cu.length)}}return[str,unit]}if(obj.geo_distance_range){obj=obj.geo_distance_range}this.field=Object.keys(obj)[0];this.lat=obj[this.field].lat;this.lon=obj[this.field].lon;var lt=obj[this.field].lt;var gte=obj[this.field].gte;if(lt){lt=lt.trim();var parts=splitUnits(lt);this.lt=parts[0];this.unit=parts[1]}if(gte){gte=gte.trim();var parts=splitUnits(gte);this.gte=parts[0];this.unit=parts[1]}};if(params.raw){this.parse(params.raw)}},newResult:function(params){if(!params){params={}}return new es.Result(params)},Result:function(params){this.data=params.raw;this.buckets=function(agg_name){return this.data.aggregations[agg_name].buckets};this.aggregation=function(agg_name){return this.data.aggregations[agg_name]};this.results=function(){var res=[];if(this.data.hits&&this.data.hits.hits){for(var i=0;i<this.data.hits.hits.length;i++){var source=this.data.hits.hits[i];if("_source"in source){res.push(source._source)}else if("fields"in source){res.push(source.fields)}}}return res};this.total=function(){if(this.data.hits&&this.data.hits.hasOwnProperty("total")){return parseInt(this.data.hits.total)}return false}},doQuery:function(params){var success=params.success;var error=params.error;var complete=params.complete;var search_url=params.search_url;var queryobj=params.queryobj;var datatype=params.datatype;var querystring=JSON.stringify(queryobj);if(es.requestMethod==="get"){$.ajax({type:"get",url:search_url,data:{source:querystring},dataType:datatype,success:es.querySuccess(success),error:es.queryError(error),complete:complete})}else if(es.requestMethod==="post"){$.ajax({type:"post",url:search_url,data:querystring,contentType:"application/json",dataType:datatype,success:es.querySuccess(success),error:es.queryError(error),complete:complete})}else{throw"es.requestMethod must be either 'get' or 'post"}},querySuccess:function(callback){return function(data){var result=es.newResult({raw:data});callback(result)}},queryError:function(callback){return function(data){if(callback){callback(data)}else{throw new Error(data)}}},getParam:function(value,def){return value!==undefined?value:def}};
var edges={newEdge:function(params){if(!params){params={}}return new edges.Edge(params)},Edge:function(params){this.selector=edges.getParam(params.selector,"body");this.search_url=edges.getParam(params.search_url,false);this.datatype=edges.getParam(params.datatype,"jsonp");this.preflightQueries=edges.getParam(params.preflightQueries,false);this.baseQuery=edges.getParam(params.baseQuery,false);this.openingQuery=edges.getParam(params.openingQuery,typeof es!=="undefined"?es.newQuery():false);this.secondaryQueries=edges.getParam(params.secondaryQueries,false);this.secondaryUrls=edges.getParam(params.secondaryUrls,false);this.initialSearch=edges.getParam(params.initialSearch,true);this.staticFiles=edges.getParam(params.staticFiles,[]);this.manageUrl=edges.getParam(params.manageUrl,false);this.urlQuerySource=edges.getParam(params.urlQuerySource,"source");this.urlQueryOptions=edges.getParam(params.urlQueryOptions,false);this.template=edges.getParam(params.template,false);this.components=edges.getParam(params.components,[]);this.renderPacks=edges.getParam(params.renderPacks,[edges.bs3,edges.nvd3,edges.highcharts,edges.google,edges.d3]);this.urlQuery=false;this.urlParams={};this.shortUrl=false;this.currentQuery=false;this.result=false;this.preflightResults={};this.realisedSecondaryQueries={};this.secondaryResults={};this.searching=false;this.context=false;this.static={};this.resources={};this.errorLoadingStatic=[];this.startup=function(){this.context=$(this.selector);this.context.trigger("edges:pre-init");if(this.manageUrl){var urlParams=this.getUrlParams();if(this.urlQuerySource in urlParams){this.urlQuery=es.newQuery({raw:urlParams[this.urlQuerySource]});delete urlParams[this.urlQuerySource]}this.urlParams=urlParams}if(this.template){this.template.draw(this)}for(var i=0;i<this.components.length;i++){var component=this.components[i];component.init(this)}this.draw();var onward=edges.objClosure(this,"startupPart2");this.loadStaticsAsync(onward)};this.startupPart2=function(){var onward=edges.objClosure(this,"startupPart3");this.runPreflightQueries(onward)};this.startupPart3=function(){var requestedQuery=this.openingQuery;if(this.urlQuery){requestedQuery=this.urlQuery;this.urlQuery=false}for(var i=0;i<this.components.length;i++){var component=this.components[i];component.contrib(requestedQuery)}this.pushQuery(requestedQuery);this.context.trigger("edges:post-init");this.cycle()};this.doQuery=function(){this.cycle()};this.cycle=function(){if(this.searching){return}this.searching=true;this.shortUrl=false;this.context.trigger("edges:pre-query");if(this.manageUrl){this.updateUrl()}if(this.search_url){var onward=edges.objClosure(this,"cyclePart2");this.doPrimaryQuery(onward)}else{this.cyclePart2()}};this.cyclePart2=function(){var onward=edges.objClosure(this,"cyclePart3");this.runSecondaryQueries(onward)};this.cyclePart3=function(){this.synchronise();this.context.trigger("edges:pre-render");this.draw();this.context.trigger("edges:post-render");this.searching=false};this.synchronise=function(){for(var i=0;i<this.components.length;i++){var component=this.components[i];component.synchronise()}};this.draw=function(){for(var i=0;i<this.components.length;i++){var component=this.components[i];component.draw(this)}};this.reset=function(){this.context.trigger("edges:pre-reset");var requestedQuery=this.cloneOpeningQuery();for(var i=0;i<this.components.length;i++){var component=this.components[i];component.contrib(requestedQuery)}this.pushQuery(requestedQuery);this.context.trigger("edges:post-reset");this.cycle()};this.cloneQuery=function(){if(this.currentQuery){return $.extend(true,{},this.currentQuery)}return false};this.pushQuery=function(query){if(this.baseQuery){query.merge(this.baseQuery)}this.currentQuery=query};this.cloneBaseQuery=function(){if(this.baseQuery){return $.extend(true,{},this.baseQuery)}return es.newQuery()};this.cloneOpeningQuery=function(){if(this.openingQuery){return $.extend(true,{},this.openingQuery)}return es.newQuery()};this.doPrimaryQuery=function(callback){var context={callback:callback};es.doQuery({search_url:this.search_url,queryobj:this.currentQuery.objectify(),datatype:this.datatype,success:edges.objClosure(this,"querySuccess",["result"],context),error:edges.objClosure(this,"queryFail",context)})};this.queryFail=function(params){var callback=params.context;this.context.trigger("edges:query-fail");callback()};this.querySuccess=function(params){this.result=params.result;var callback=params.callback;this.context.trigger("edges:query-success");callback()};this.runPreflightQueries=function(callback){if(!this.preflightQueries||Object.keys(this.preflightQueries).length==0){callback();return}this.context.trigger("edges:pre-preflight");var entries=[];var ids=Object.keys(this.preflightQueries);for(var i=0;i<ids.length;i++){var id=ids[i];entries.push({id:id,query:this.preflightQueries[id]})}var that=this;var pg=edges.newAsyncGroup({list:entries,action:function(params){var entry=params.entry;var success=params.success_callback;var error=params.error_callback;es.doQuery({search_url:that.search_url,queryobj:entry.query.objectify(),datatype:that.datatype,success:success,error:error})},successCallbackArgs:["result"],success:function(params){var result=params.result;var entry=params.entry;that.preflightResults[entry.id]=result},errorCallbackArgs:["result"],error:function(params){that.context.trigger("edges:error-preflight")},carryOn:function(){that.context.trigger("edges:post-preflight");callback()}});pg.process()};this.runSecondaryQueries=function(callback){this.realisedSecondaryQueries={};if(!this.secondaryQueries||Object.keys(this.secondaryQueries).length==0){callback();return}var entries=[];for(var key in this.secondaryQueries){var entry={};entry["query"]=this.secondaryQueries[key](this);entry["id"]=key;entry["search_url"]=this.search_url;if(this.secondaryUrls!==false&&this.secondaryUrls.hasOwnProperty(key)){entry["search_url"]=this.secondaryUrls[key]}entries.push(entry);this.realisedSecondaryQueries[key]=entry.query}var that=this;var pg=edges.newAsyncGroup({list:entries,action:function(params){var entry=params.entry;var success=params.success_callback;var error=params.error_callback;es.doQuery({search_url:entry.search_url,queryobj:entry.query.objectify(),datatype:that.datatype,success:success,complete:false})},successCallbackArgs:["result"],success:function(params){var result=params.result;var entry=params.entry;that.secondaryResults[entry.id]=result},errorCallbackArgs:["result"],error:function(params){},carryOn:function(){callback()}});pg.process()};this.getComponent=function(params){var id=params.id;for(var i=0;i<this.components.length;i++){var component=this.components[i];if(component.id===id){return component}}return false};this.category=function(cat){var comps=[];for(var i=0;i<this.components.length;i++){var component=this.components[i];if(component.category===cat){comps.push(component)}}return comps};this.getRenderPackObject=function(oname,params){for(var i=0;i<this.renderPacks.length;i++){var rp=this.renderPacks[i];if(rp&&rp.hasOwnProperty(oname)){return rp[oname](params)}}};this.jq=function(selector){return $(selector,this.context)};this.getUrlParams=function(){return edges.getUrlParams()};this.urlQueryArg=function(objectify_options){if(!objectify_options){if(this.urlQueryOptions){objectify_options=this.urlQueryOptions}else{objectify_options={include_query_string:true,include_filters:true,include_paging:true,include_sort:true,include_fields:false,include_aggregations:false}}}var q=JSON.stringify(this.currentQuery.objectify(objectify_options));var obj={};obj[this.urlQuerySource]=encodeURIComponent(q);return obj};this.fullQueryArgs=function(){var args=$.extend(true,{},this.urlParams);$.extend(args,this.urlQueryArg());return args};this.fullUrlQueryString=function(){return this._makeUrlQuery(this.fullQueryArgs())};this._makeUrlQuery=function(args){var keys=Object.keys(args);var entries=[];for(var i=0;i<keys.length;i++){var key=keys[i];var val=args[key];entries.push(key+"="+val)}return entries.join("&")};this.fullUrl=function(){var args=this.fullQueryArgs();var fragment="";if(args["#"]){fragment="#"+args["#"];delete args["#"]}var wloc=window.location.toString();var bits=wloc.split("?");var url=bits[0]+"?"+this._makeUrlQuery(args)+fragment;return url};this.updateUrl=function(){if("pushState"in window.history){var qs="?"+this.fullUrlQueryString();window.history.pushState("","",qs)}};this.loadStaticsAsync=function(callback){if(!this.staticFiles||this.staticFiles.length==0){this.context.trigger("edges:post-load-static");callback();return}var that=this;var pg=edges.newAsyncGroup({list:this.staticFiles,action:function(params){var entry=params.entry;var success=params.success_callback;var error=params.error_callback;var id=entry.id;var url=entry.url;var datatype=edges.getParam(entry.datatype,"text");$.ajax({type:"get",url:url,dataType:datatype,success:success,error:error})},successCallbackArgs:["data"],success:function(params){var data=params.data;var entry=params.entry;if(entry.processor){var processed=entry.processor({data:data});that.resources[entry.id]=processed;if(entry.opening){entry.opening({resource:processed,edge:that})}}that.static[entry.id]=data},errorCallbackArgs:["data"],error:function(params){that.errorLoadingStatic.push(params.entry.id);that.context.trigger("edges:error-load-static")},carryOn:function(){that.context.trigger("edges:post-load-static");callback()}});pg.process()};this.startup()},newAsyncGroup:function(params){if(!params){params={}}return new edges.AsyncGroup(params)},AsyncGroup:function(params){this.list=params.list;this.successCallbackArgs=params.successCallbackArgs;this.errorCallbackArgs=params.errorCallbackArgs;var action=params.action;var success=params.success;var carryOn=params.carryOn;var error=params.error;this.functions={action:action,success:success,carryOn:carryOn,error:error};this.checkList=[];this.finished=false;this.construct=function(params){for(var i=0;i<this.list.length;i++){this.checkList.push(0)}};this.process=function(params){if(this.list.length==0){this.functions.carryOn()}for(var i=0;i<this.list.length;i++){var context={index:i};var success_callback=edges.objClosure(this,"_actionSuccess",this.successCallbackArgs,context);var error_callback=edges.objClosure(this,"_actionError",this.successCallbackArgs,context);var complete_callback=false;this.functions.action({entry:this.list[i],success_callback:success_callback,error_callback:error_callback,complete_callback:complete_callback})}};this._actionSuccess=function(params){var index=params.index;delete params.index;params["entry"]=this.list[index];this.functions.success(params);this.checkList[index]=1;if(this._isComplete()){this._finalise()}};this._actionError=function(params){var index=params.index;delete params.index;params["entry"]=this.list[index];this.functions.error(params);this.checkList[index]=-1;if(this._isComplete()){this._finalise()}};this._actionComplete=function(params){};this._isComplete=function(){return $.inArray(0,this.checkList)===-1};this._finalise=function(){if(this.finished){return}this.finished=true;this.functions.carryOn()};this.construct()},newRenderer:function(params){if(!params){params={}}return new edges.Renderer(params)},Renderer:function(params){this.component=params.component||false;this.init=function(component){this.component=component};this.draw=function(component){}},newComponent:function(params){if(!params){params={}}return new edges.Component(params)},Component:function(params){this.id=params.id;this.renderer=params.renderer;this.category=params.category||"none";this.defaultRenderer=params.defaultRenderer||"newRenderer";this.init=function(edge){this.edge=edge;this.context=this.edge.jq("#"+this.id);if(!this.renderer){this.renderer=this.edge.getRenderPackObject(this.defaultRenderer)}if(this.renderer){this.renderer.init(this)}};this.draw=function(){if(this.renderer){this.renderer.draw()}};this.contrib=function(query){};this.synchronise=function(){};this.jq=function(selector){return this.edge.jq(selector)}},newSelector:function(params){if(!params){params={}}edges.Selector.prototype=edges.newComponent(params);return new edges.Selector(params)},Selector:function(params){this.field=params.field;this.display=params.display||this.field;this.active=params.active||true;this.disabled=params.disabled||false;this.category=params.category||"selector"},newTemplate:function(params){if(!params){params={}}return new edges.Template(params)},Template:function(params){this.draw=function(edge){}},instantiate:function(clazz,params,protoConstructor){if(!params){params={}}if(protoConstructor){clazz.prototype=protoConstructor(params)}var inst=new clazz(params);if(protoConstructor){inst.__proto_constructor__=protoConstructor}return inst},up:function(inst,fn,args){var parent=new inst.__proto_constructor__;parent[fn].apply(inst,args)},objClosure:function(obj,fn,args,context_params){return function(){if(args){var params={};for(var i=0;i<args.length;i++){if(arguments.length>i){params[args[i]]=arguments[i]}}if(context_params){params=$.extend(params,context_params)}obj[fn](params)}else{var slice=Array.prototype.slice;var theArgs=slice.apply(arguments);if(context_params){theArgs.push(context_params)}obj[fn].apply(obj,theArgs)}}},eventClosure:function(obj,fn,conditional){return function(event){if(conditional){if(!conditional(event)){return}}event.preventDefault();obj[fn](this)}},css_classes:function(namespace,field,renderer){var cl=namespace+"-"+field;if(renderer){cl+=" "+cl+"-"+renderer.component.id}return cl},css_class_selector:function(namespace,field,renderer){var sel="."+namespace+"-"+field;if(renderer){sel+=sel+"-"+renderer.component.id}return sel},css_id:function(namespace,field,renderer){var id=namespace+"-"+field;if(renderer){id+="-"+renderer.component.id}return id},css_id_selector:function(namespace,field,renderer){return"#"+edges.css_id(namespace,field,renderer)},on:function(selector,event,caller,targetFunction,delay,conditional){if(caller.component&&caller.component.id){event=event+"."+caller.component.id}else if(caller.namespace){event=event+"."+caller.namespace}var clos=edges.eventClosure(caller,targetFunction,conditional);if(delay){if(caller.component){caller.component.jq(selector).bindWithDelay(event,clos,delay)}else if(caller.edge){caller.edge.jq(selector).bindWithDelay(event,clos,delay)}else{$(selector).bindWithDelay(event,clos,delay)}}else{if(caller.component){var element=caller.component.jq(selector);element.off(event);element.on(event,clos)}else if(caller.edge){var element=caller.edge.jq(selector);element.off(event);element.on(event,clos)}else{var element=$(selector);element.off(event);element.on(event,clos)}}},getUrlParams:function(){var params={};var url=window.location.href;var fragment=false;if(url.indexOf("#")>-1){fragment=url.slice(url.indexOf("#"));url=url.substring(0,url.indexOf("#"))}var args=url.slice(url.indexOf("?")+1).split("&");for(var i=0;i<args.length;i++){var kv=args[i].split("=");if(kv.length===2){var key=kv[0].replace(/\+/g,"%20");key=decodeURIComponent(key);var val=kv[1].replace(/\+/g,"%20");val=decodeURIComponent(val);if(val[0]=="["||val[0]=="{"){val=val.replace(/^"/,"").replace(/"$/,"");val=JSON.parse(val)}params[key]=val}}if(fragment){params["#"]=fragment}return params},escapeHtml:function(unsafe,def){if(def===undefined){def=""}if(unsafe===undefined||unsafe==null){return def}try{if(typeof unsafe.replace!=="function"){return unsafe}return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}catch(err){return def}},objVal:function(path,rec,def){if(def===undefined){def=false}var bits=path.split(".");var val=rec;for(var i=0;i<bits.length;i++){var field=bits[i];if(field in val){val=val[field]}else{return def}}return val},getParam:function(value,def){return value!==undefined?value:def},safeId:function(unsafe){return unsafe.replace(/&/g,"_").replace(/</g,"_").replace(/>/g,"_").replace(/"/g,"_").replace(/'/g,"_").replace(/\./gi,"_").replace(/\:/gi,"_").replace(/\s/gi,"_")},numFormat:function(params){var reflectNonNumbers=edges.getParam(params.reflectNonNumbers,false);var prefix=edges.getParam(params.prefix,"");var zeroPadding=edges.getParam(params.zeroPadding,false);var decimalPlaces=edges.getParam(params.decimalPlaces,false);var thousandsSeparator=edges.getParam(params.thousandsSeparator,false);var decimalSeparator=edges.getParam(params.decimalSeparator,".");var suffix=edges.getParam(params.suffix,"");return function(number){var num=parseFloat(number);if(isNaN(num)){if(reflectNonNumbers){return number}else{return num}}if(decimalPlaces!==false){num=num.toFixed(decimalPlaces)}else{num=num.toString()}var bits=num.split(".");if(zeroPadding!==false){var zeros=zeroPadding-bits[0].length;var pad="";for(var i=0;i<zeros;i++){pad+="0"}bits[0]=pad+bits[0]}if(thousandsSeparator!==false){bits[0]=bits[0].replace(/\B(?=(\d{3})+(?!\d))/g,thousandsSeparator)}if(bits.length==1){return prefix+bits[0]+suffix}else{return prefix+bits[0]+decimalSeparator+bits[1]+suffix}}},numParse:function(params){var commaRx=new RegExp(",","g");return function(num){num=num.trim();num=num.replace(commaRx,"");if(num===""){return 0}return parseFloat(num)}},isEmptyObject:function(obj){for(var key in obj){if(obj.hasOwnProperty(key))return false}return true}};
$.extend(edges,{newFilterSetter:function(params){if(!params){params={}}edges.FilterSetter.prototype=edges.newComponent(params);return new edges.FilterSetter(params)},FilterSetter:function(params){this.filters=edges.getParam(params.filters,[]);this.aggregations=edges.getParam(params.aggregations,[]);this.defaultRenderer=edges.getParam(params.defaultRenderer,"newFilterSetterRenderer");this.filter_counts={};this.active_filters={};this.contrib=function(query){for(var i=0;i<this.aggregations.length;i++){query.addAggregation(this.aggregations[i])}};this.synchronise=function(){for(var i=0;i<this.filters.length;i++){var filter_def=this.filters[i];if(!filter_def.agg_name||!filter_def.bucket_field||!filter_def.bucket_value){continue}var agg=this.edge.result.aggregation(filter_def.agg_name);if(!agg){continue}var bfield=filter_def.bucket_field;var bvalue=filter_def.bucket_value;var count=0;var buckets=agg.buckets;for(var k=0;k<buckets.length;k++){var bucket=buckets[k];if(bucket[bfield]&&bucket[bfield]==bvalue){count=bucket["doc_count"];break}}this.filter_counts[filter_def.id]=count}for(var i=0;i<this.filters.length;i++){var filter_def=this.filters[i];if(!filter_def.must){continue}var toactivate=filter_def.must.length;var active=0;for(var j=0;j<filter_def.must.length;j++){var must=filter_def.must[j];var current=this.edge.currentQuery.listMust(must);if(current.length>0){active+=1}}if(active===toactivate){this.active_filters[filter_def.id]=true}else{this.active_filters[filter_def.id]=false}}};this.addFilter=function(filter_id){var filter=false;for(var i=0;i<this.filters.length;i++){if(this.filters[i].id===filter_id){filter=this.filters[i];break}}if(!filter||!filter.must){return}var nq=this.edge.cloneQuery();for(var i=0;i<filter.must.length;i++){var must=filter.must[i];nq.addMust(must)}nq.from=0;this.edge.pushQuery(nq);this.edge.doQuery()};this.removeFilter=function(filter_id){var filter=false;for(var i=0;i<this.filters.length;i++){if(this.filters[i].id===filter_id){filter=this.filters[i];break}}if(!filter||!filter.must){return}var nq=this.edge.cloneQuery();for(var i=0;i<filter.must.length;i++){var must=filter.must[i];nq.removeMust(must)}nq.from=0;this.edge.pushQuery(nq);this.edge.doQuery()}},newFullSearchController:function(params){if(!params){params={}}edges.FullSearchController.prototype=edges.newComponent(params);return new edges.FullSearchController(params)},FullSearchController:function(params){this.fuzzify=params.fuzzify||false;this.sortOptions=params.sortOptions||false;this.fieldOptions=params.fieldOptions||false;this.urlShortener=params.urlShortener||false;this.defaultOperator=params.defaultOperator||"OR";this.defaultRenderer=params.defaultRenderer||"newFullSearchControllerRenderer";this.searchField=false;this.searchString=false;this.sortBy=false;this.sortDir="desc";this.shortUrl=false;this.synchronise=function(){this.searchString=false;this.searchField=false;this.sortBy=false;this.sortDir="desc";if(this.edge.currentQuery){var qs=this.edge.currentQuery.getQueryString();if(qs){this.searchString=qs.queryString;this.searchField=qs.defaultField}var sorts=this.edge.currentQuery.getSortBy();if(sorts.length>0){this.sortBy=sorts[0].field;this.sortDir=sorts[0].order}}};this.setSort=function(params){var dir=params.dir;var field=params.field;if(dir===undefined||dir===false){dir="desc"}var nq=this.edge.cloneQuery();nq.setSortBy(es.newSort({field:field,order:dir}));nq.from=0;this.edge.pushQuery(nq);this.edge.doQuery()};this.changeSortDir=function(){var dir=this.sortDir==="asc"?"desc":"asc";var sort=this.sortBy?this.sortBy:"_score";var nq=this.edge.cloneQuery();nq.setSortBy(es.newSort({field:sort,order:dir}));nq.from=0;this.edge.pushQuery(nq);this.edge.doQuery()};this.setSortBy=function(field){var nq=this.edge.cloneQuery();if(!field||field===""){field="_score"}nq.setSortBy(es.newSort({field:field,order:this.sortDir}));nq.from=0;this.edge.pushQuery(nq);this.edge.doQuery()};this.setSearchField=function(field){this.searchField=field;if(!this.searchString||this.searchString===""){return}var nq=this.edge.cloneQuery();nq.setQueryString(es.newQueryString({queryString:this.searchString,defaultField:field,defaultOperator:this.defaultOperator,fuzzify:this.fuzzify}));nq.from=0;this.edge.pushQuery(nq);this.edge.doQuery()};this.setSearchText=function(text){var nq=this.edge.cloneQuery();if(text!==""){var params={queryString:text,defaultOperator:this.defaultOperator,fuzzify:this.fuzzify};if(this.searchField&&this.searchField!==""){params["defaultField"]=this.searchField}nq.setQueryString(es.newQueryString(params))}else{nq.removeQueryString()}nq.from=0;this.edge.pushQuery(nq);this.edge.doQuery()};this.clearSearch=function(){this.edge.reset()}},newSelectedFilters:function(params){if(!params){params={}}edges.SelectedFilters.prototype=edges.newComponent(params);return new edges.SelectedFilters(params)},SelectedFilters:function(params){this.fieldDisplays=edges.getParam(params.fieldDisplays,{});this.valueMaps=edges.getParam(params.valueMaps,{});this.valueFunctions=edges.getParam(params.valueFunctions,{});this.rangeMaps=edges.getParam(params.rangeMaps,{});this.rangeFunctions=edges.getParam(params.rangeFunctions,{});this.formatUnknownRange=edges.getParam(params.formatUnknownRange,false);this.defaultRenderer=edges.getParam(params.defaultRenderer,"newSelectedFiltersRenderer");this.mustFilters={};this.searchString=false;this.searchField=false;this.synchronise=function(){this.mustFilters={};this.searchString=false;this.searchField=false;if(!this.edge.currentQuery){return}var musts=this.edge.currentQuery.listMust();for(var i=0;i<musts.length;i++){var f=musts[i];if(f.type_name==="term"){this._synchronise_term(f)}else if(f.type_name==="terms"){this._synchronise_terms(f)}else if(f.type_name==="range"){this._synchronise_range(f)}else if(f.type_name==="geo_distance_range"){}}var qs=this.edge.currentQuery.getQueryString();if(qs){this.searchString=qs.queryString;this.searchField=qs.defaultField}};this.removeFilter=function(boolType,filterType,field,value){var nq=this.edge.cloneQuery();if(filterType==="term"){var template=es.newTermFilter({field:field,value:value});if(boolType==="must"){nq.removeMust(template)}}else if(filterType==="terms"){var template=es.newTermsFilter({field:field});if(boolType==="must"){var filters=nq.listMust(template);for(var i=0;i<filters.length;i++){if(filters[i].has_term(value)){filters[i].remove_term(value)}if(!filters[i].has_terms()){nq.removeMust(filters[i])}}}}else if(filterType=="range"){var params={field:field};if(value.to){params[value.toType]=value.to}if(value.from){params[value.fromType]=value.from}var template=es.newRangeFilter(params);if(boolType==="must"){nq.removeMust(template)}}else if(filterType=="geo_distance_range"){}nq.from=0;this.edge.pushQuery(nq);this.edge.doQuery()};this.clearQueryString=function(){var nq=this.edge.cloneQuery();nq.removeQueryString();nq.from=0;this.edge.pushQuery(nq);this.edge.doQuery()};this.clearSearch=function(){this.edge.reset()};this._synchronise_term=function(filter){var display=this.fieldDisplays[filter.field]||filter.field;if(filter.field in this.mustFilters){this.mustFilters[filter.field].values.push({val:filter.value,display:this._translate(filter.field,filter.value)})}else{this.mustFilters[filter.field]={filter:filter.type_name,display:display,values:[{val:filter.value,display:this._translate(filter.field,filter.value)}],rel:"AND"}}};this._synchronise_terms=function(filter){var display=this.fieldDisplays[filter.field]||filter.field;var values=[];for(var i=0;i<filter.values.length;i++){var v=filter.values[i];var d=this._translate(filter.field,v);values.push({val:v,display:d})}this.mustFilters[filter.field]={filter:filter.type_name,display:display,values:values,rel:"OR"}};this._synchronise_range=function(filter){var display=this.fieldDisplays[filter.field]||filter.field;var to=filter.lt;var toType="lt";if(to===false){to=filter.lte;toType="lte"}var from=filter.gte;var fromType="gte";if(from===false){from=filter.gt;fromType="gt"}var r=this._getRangeDef(filter.field,from,to);var values=[];if(!r){values.push({to:to,toType:toType,from:from,fromType:fromType,display:this._formatUnknown(from,to)})}else{values.push(r)}this.mustFilters[filter.field]={filter:filter.type_name,display:display,values:values}};this._translate=function(field,value){if(field in this.valueMaps){if(value in this.valueMaps[field]){return this.valueMaps[field][value]}}else if(field in this.valueFunctions){return this.valueFunctions[field](value)}return value};this._getRangeDef=function(field,from,to){if(!this.rangeMaps[field]&&!this.rangeFunctions[field]){return false}if(this.rangeMaps[field]){for(var i=0;i<this.rangeMaps[field].length;i++){var r=this.rangeMaps[field][i];var frMatch=true;var toMatch=true;if(from&&!r.from||!from&&r.from){frMatch=false}if(to&&!r.to||!to&&r.to){toMatch=false}if(from&&r.from&&from!==r.from){frMatch=false}if(to&&r.to&&to!==r.to){toMatch=false}if(frMatch&&toMatch){return r}}}else if(this.rangeFunctions[field]){var fn=this.rangeFunctions[field];return fn({field:field,from:from,to:to})}return false};this._formatUnknown=function(from,to){if(this.formatUnknownRange){return this.formatUnknownRange(from,to)}else{if(from!==false||to!==false){if(from===to){return from}}var frag="";if(from!==false){frag+=from}else{frag+="< "}if(to!==false){if(from!==false){frag+=" - "+to}else{frag+=to}}else{if(from!==false){frag+="+"}else{frag="unknown"}}return frag}}},newPager:function(params){if(!params){params={}}edges.Pager.prototype=edges.newComponent(params);return new edges.Pager(params)},Pager:function(params){this.defaultRenderer=params.defaultRenderer||"newPagerRenderer";this.from=false;this.to=false;this.total=false;this.page=false;this.pageSize=false;this.totalPages=false;this.synchronise=function(){this.from=false;this.to=false;this.total=false;this.page=false;this.pageSize=false;this.totalPages=false;if(this.edge.currentQuery){this.from=parseInt(this.edge.currentQuery.getFrom())+1;this.pageSize=parseInt(this.edge.currentQuery.getSize())}if(this.edge.result){this.total=this.edge.result.total()}if(this.from!==false&&this.total!==false){this.to=this.from+this.pageSize-1;this.page=Math.ceil((this.from-1)/this.pageSize)+1;this.totalPages=Math.ceil(this.total/this.pageSize)}};this.setFrom=function(from){var nq=this.edge.cloneQuery();from=from-1;if(from<0){from=0}nq.from=from;this.edge.pushQuery(nq);this.edge.doQuery()};this.setSize=function(size){var nq=this.edge.cloneQuery();nq.size=size;this.edge.pushQuery(nq);this.edge.doQuery()};this.decrementPage=function(){var from=this.from-this.pageSize;this.setFrom(from)};this.incrementPage=function(){var from=this.from+this.pageSize;this.setFrom(from)};this.goToPage=function(params){var page=params.page;var nf=(page-1)*this.pageSize+1;this.setFrom(nf)}},newSearchingNotification:function(params){if(!params){params={}}edges.SearchingNotification.prototype=edges.newComponent(params);return new edges.SearchingNotification(params)},SearchingNotification:function(params){this.defaultRenderer=params.defaultRenderer||"newSearchingNotificationRenderer";this.searching=false;this.init=function(edge){Object.getPrototypeOf(this).init.call(this,edge);edge.context.on("edges:pre-query",edges.eventClosure(this,"searchingBegan"));edge.context.on("edges:query-fail",edges.eventClosure(this,"searchingFinished"));edge.context.on("edges:query-success",edges.eventClosure(this,"searchingFinished"))};this.draw=function(){};this.searchingBegan=function(){this.searching=true;this.renderer.draw()};this.searchingFinished=function(){this.searching=false;this.renderer.draw()}},newLeaveSearchNavigation:function(params){return edges.instantiate(edges.LeaveSearchNavigation,params,edges.newComponent)},LeaveSearchNavigation:function(params){this.include_query_string=edges.getParam(params.include_query_string,true);this.include_filters=edges.getParam(params.include_filters,true);this.include_paging=edges.getParam(params.include_paging,false);this.include_sort=edges.getParam(params.include_sort,false);this.include_fields=edges.getParam(params.include_fields,false);this.include_aggregations=edges.getParam(params.include_aggregations,false);this.urlTemplate=edges.getParam(params.urlTemplate,"{query}");this.urlQueryPlaceholder=edges.getParam(params.urlQueryPlaceholder,"{query}");this.link="#";this.synchronise=function(){this.link="#";if(this.edge.currentQuery!==false){var queryobj=this.edge.currentQuery.objectify({include_query_string:this.include_query_string,include_filters:this.include_filters,include_paging:this.include_paging,include_sort:this.include_sort,include_fields:this.include_fields,include_aggregations:this.include_aggregations});var j=JSON.stringify(queryobj);var frag=encodeURIComponent(j);this.link=this.urlTemplate.replace(this.urlQueryPlaceholder,frag)}}},newResultsDisplay:function(params){if(!params){params={}}edges.ResultsDisplay.prototype=edges.newComponent(params);return new edges.ResultsDisplay(params)},ResultsDisplay:function(params){this.category=params.category||"results";this.secondaryResults=edges.getParam(params.secondaryResults,false);this.filter=edges.getParam(params.filter,false);this.sort=edges.getParam(params.sort,false);this.limit=edges.getParam(params.limit,false);this.defaultRenderer=params.defaultRenderer||"newResultsDisplayRenderer";this.results=false;this.synchronise=function(){this.results=[];var source=this.edge.result;if(this.secondaryResults!==false){source=this.edge.secondaryResults[this.secondaryResults]}if(!source){return}var results=source.results();if(this.filter){results=this.filter({results:results})}if(this.sort){results.sort(this.sort)}if(this.limit!==false){results=results.slice(0,this.limit)}this.results=results}}});
$.extend(true,edges,{bs3:{newImportantNumbersRenderer:function(params){if(!params){params={}}edges.bs3.ImportantNumbersRenderer.prototype=edges.newRenderer(params);return new edges.bs3.ImportantNumbersRenderer(params)},ImportantNumbersRenderer:function(params){this.title=edges.getParam(params.title,false);this.backgroundImg=edges.getParam(params.backgroundImg,false);this.mainNumberFormat=edges.getParam(params.mainNumberFormat,false);this.secondNumberFormat=edges.getParam(params.secondNumberFormat,false);this.resizeHandler=edges.getParam(params.resizeHandler,false);this.namespace="edges-bs3-important-numbers";this.draw=function(){var containerClass=edges.css_classes(this.namespace,"container",this);var graphicClass=edges.css_classes(this.namespace,"graphic",this);var titleFrag="";if(this.title!==false){var titleClass=edges.css_classes(this.namespace,"title",this);titleFrag='<div class="'+titleClass+'">'+this.title+"</div>"}var backgroundFrag="";if(this.backgroundImg!==false){var backgroundClass=edges.css_classes(this.namespace,"img",this);backgroundFrag+='<div class="'+backgroundClass+'"><img src="'+this.backgroundImg+'"></div>'}var mainFrag="";if(this.component.main!==false){var val=this.component.main;if(this.mainNumberFormat!==false){val=this.mainNumberFormat(val)}var mainClass=edges.css_classes(this.namespace,"main",this);mainFrag='<div class="'+mainClass+'">'+val+"</div>"}var secondFrag="";if(this.component.second!==false){var val=this.component.second;if(this.secondNumberFormat!==false){val=this.secondNumberFormat(val)}var secondClass=edges.css_classes(this.namespace,"second",this);secondFrag='<div class="'+secondClass+'">'+val+"</div>"}var frag='<div class="'+containerClass+'">'+titleFrag+'<div class="'+graphicClass+'">'+backgroundFrag+mainFrag+"</div>"+secondFrag+"</div>";this.component.context.html(frag);if(this.resizeHandler){this.resizeHandler(this);edges.on(window,"resize",this,"draw")}}}}});
$.extend(edges,{newChart:function(params){if(!params){params={}}edges.Chart.prototype=edges.newComponent(params);return new edges.Chart(params)},Chart:function(params){this.category=params.category||"chart";this.display=params.display||"";this.dataSeries=params.dataSeries||false;this.dataFunction=params.dataFunction||false;this.dataFunctionClosure=params.dataFunctionClosure||false;this.aggregations=params.aggregations||[];this.dfArgs=params.dfArgs||{useAggregations:[],seriesKeys:{}};this.dataSeriesNameMapFunction=edges.getParam(params.dataSeriesNameMapFunction,false);this.dataSeriesNameMap=edges.getParam(params.dataSeriesNameMap,{});this.defaultRenderer=params.defaultRenderer||"newMultibarRenderer";this.init=function(edge){edges.newComponent().init.call(this,edge);for(var i=0;i<this.aggregations.length;i++){var agg=this.aggregations[i];if($.inArray(agg.name,this.dfArgs.useAggregations)===-1){this.dfArgs.useAggregations.push(agg.name)}}if(this.aggregations.length>0&&this.dataFunctionClosure){this.dataFunction=this.dataFunctionClosure(this.dfArgs)}};this.contrib=function(query){for(var i=0;i<this.aggregations.length;i++){query.addAggregation(this.aggregations[i])}};this.synchronise=function(){if(this.dataFunction){this.dataSeries=this.dataFunction(this)}if(this.dataSeriesNameMapFunction){this.dataSeriesNameMap=this.dataSeriesNameMapFunction(this)}}},ChartDataFunctions:{terms:function(params){var useAggregations=params.useAggregations||[];var seriesKeys=params.seriesKeys||{};return function(ch){var data_series=[];if(!ch.edge.result){return data_series}for(var i=0;i<useAggregations.length;i++){var agg=useAggregations[i];var buckets=ch.edge.result.data.aggregations[agg].buckets;var series={};series["key"]=seriesKeys[agg];series["values"]=[];for(var j=0;j<buckets.length;j++){var doccount=buckets[j].doc_count;var key=buckets[j].key;series.values.push({label:key,value:doccount})}data_series.push(series)}return data_series}},termsStats:function(params){var useAggregations=params.useAggregations||[];var seriesKeys=params.seriesKeys||{};var seriesFor=params.seriesFor||[];return function(ch){var data_series=[];if(!ch.edge.result){return data_series}for(var i=0;i<useAggregations.length;i++){var agg=useAggregations[i];var parts=agg.split(" ");for(var j=0;j<seriesFor.length;j++){var seriesStat=seriesFor[j];var series={};series["key"]=seriesKeys[agg+" "+seriesStat];series["values"]=[];var buckets=ch.edge.result.data.aggregations[parts[0]].buckets;for(var k=0;k<buckets.length;k++){var stats=buckets[k][parts[1]];var key=buckets[k].key;var val=stats[seriesStat];series.values.push({label:key,value:val})}data_series.push(series)}}return data_series}},recordsXY:function(params){var x=params.x;var x_default=params.x_default===undefined?0:params.x_default;var y=params.y;var y_default=params.y_default===undefined?0:params.y_default;var key=params.key;return function(ch){var data_series=[];if(!ch.edge.result){return data_series}var series={};series["key"]=key;series["values"]=[];var results=ch.edge.result.results();for(var i=0;i<results.length;i++){var res=results[i];var xval=edges.objVal(x,res,x_default);var yval=edges.objVal(y,res,y_default);series.values.push({label:xval,value:yval})}data_series.push(series);return data_series}},cumulativeXY:function(params){var x=params.x;var x_default=params.x_default===undefined?0:params.x_default;var y=params.y;var y_default=params.y_default===undefined?0:params.y_default;var key=params.key;var accumulate=params.accumulate||"y";return function(ch){var data_series=[];if(!ch.edge.result){return data_series}var series={};series["key"]=key;series["values"]=[];var total=0;var results=ch.edge.result.results();for(var i=0;i<results.length;i++){var res=results[i];var xval=edges.objVal(x,res,x_default);var yval=edges.objVal(y,res,y_default);if(accumulate==="x"){total+=xval;series.values.push({label:total,value:yval})}else if(accumulate==="y"){total+=yval;series.values.push({label:xval,value:total})}}data_series.push(series);return data_series}},totalledList:function(params){var listPath=params.listPath||"";var seriesKey=params.seriesKey||"";var keyField=params.keyField||false;var valueField=params.valueField||false;return function(ch){var data_series=[];if(!ch.edge.result){return data_series}var series={};series["key"]=seriesKey;series["values"]=[];var counter={};var results=ch.edge.result.results();for(var i=0;i<results.length;i++){var res=results[i];var l=edges.objVal(listPath,res,[]);for(var j=0;j<l.length;j++){var lo=l[j];var key=edges.objVal(keyField,lo,false);var value=edges.objVal(valueField,lo,0);if(key in counter){counter[key]+=value}else{counter[key]=value}}}for(key in counter){var val=counter[key];series.values.push({label:key,value:val})}data_series.push(series);return data_series}}},newPieChart:function(params){if(!params){params={}}edges.PieChart.prototype=edges.newChart(params);return new edges.PieChart(params)},PieChart:function(params){this.defaultRenderer=params.defaultRenderer||"newPieChartRenderer"},newHorizontalMultibar:function(params){if(!params){params={}}edges.HorizontalMultibar.prototype=edges.newChart(params);return new edges.HorizontalMultibar(params)},HorizontalMultibar:function(params){this.defaultRenderer=params.defaultRenderer||"newHorizontalMultibarRenderer"},newMultibar:function(params){if(!params){params={}}edges.Multibar.prototype=edges.newChart(params);return new edges.Multibar(params)},Multibar:function(params){this.defaultRenderer=params.defaultRenderer||"newMultibarRenderer"},newSimpleLineChart:function(params){if(!params){params={}}edges.SimpleLineChart.prototype=edges.newChart(params);return new edges.SimpleLineChart(params)},SimpleLineChart:function(params){this.xAxisLabel=params.xAxisLabel||"";this.yAxisLabel=params.yAxisLabel||"";this.defaultRenderer=params.defaultRenderer||"newSimpleLineChartRenderer"},newChartsTable:function(params){if(!params){params={}}edges.ChartsTable.prototype=edges.newComponent(params);return new edges.ChartsTable(params)},ChartsTable:function(params){this.chartComponents=edges.getParam(params.chartComponents,false);this.tabularise=edges.getParam(params.tabularise,false);this.defaultRenderer=params.defaultRenderer||"newChartsTableRenderer";this.results=[];this.synchronise=function(){this.results=[];if(!this.chartComponents){return}var comps=[];for(var i=0;i<this.edge.components.length;i++){var comp=this.edge.components[i];if($.inArray(comp.id,this.chartComponents)>-1){comps.push(comp)}}if(this.tabularise){this.results=this.tabularise(comps)}}}});
$.extend(true,edges,{bs3:{newSelectedFiltersRenderer:function(params){if(!params){params={}}edges.bs3.SelectedFiltersRenderer.prototype=edges.newRenderer(params);return new edges.bs3.SelectedFiltersRenderer(params)},SelectedFiltersRenderer:function(params){this.showFilterField=edges.getParam(params.showFilterField,true);this.allowRemove=edges.getParam(params.allowRemove,true);this.showSearchString=edges.getParam(params.showSearchString,false);this.ifNoFilters=edges.getParam(params.ifNoFilters,false);this.namespace="edges-bs3-selected-filters";this.draw=function(){var sf=this.component;var ns=this.namespace;var fieldClass=edges.css_classes(ns,"field",this);var fieldNameClass=edges.css_classes(ns,"fieldname",this);var valClass=edges.css_classes(ns,"value",this);var relClass=edges.css_classes(ns,"rel",this);var containerClass=edges.css_classes(ns,"container",this);var filters="";if(this.showSearchString&&sf.searchString){var field=sf.searchField;var text=sf.searchString;filters+='<span class="'+fieldClass+'">';if(field){if(field in sf.fieldDisplays){field=sf.fieldDisplays[field]}filters+='<span class="'+fieldNameClass+'">'+field+":</span>"}filters+='<span class="'+valClass+'">"'+text+'"</span>';filters+="</span>"}var fields=Object.keys(sf.mustFilters);for(var i=0;i<fields.length;i++){var field=fields[i];var def=sf.mustFilters[field];filters+='<span class="'+fieldClass+'">';if(this.showFilterField){filters+='<span class="'+fieldNameClass+'">'+def.display+":</span>"}for(var j=0;j<def.values.length;j++){var val=def.values[j];filters+='<span class="'+valClass+'">'+val.display+"</span>";if(this.allowRemove){var removeClass=edges.css_classes(ns,"remove",this);if(def.filter=="term"||def.filter==="terms"){filters+='<a class="'+removeClass+'" data-bool="must" data-filter="'+def.filter+'" data-field="'+field+'" data-value="'+val.val+'" alt="Remove" title="Remove" href="#">';filters+='<i class="glyphicon glyphicon-black glyphicon-remove"></i>';filters+="</a>"}else if(def.filter==="range"){var from=val.from?" data-"+val.fromType+'="'+val.from+'" ':"";var to=val.to?" data-"+val.toType+'="'+val.to+'" ':"";filters+='<a class="'+removeClass+'" data-bool="must" data-filter="'+def.filter+'" data-field="'+field+'" '+from+to+' alt="Remove" title="Remove" href="#">';filters+='<i class="glyphicon glyphicon-black glyphicon-remove"></i>';filters+="</a>"}}if(def.rel){if(j+1<def.values.length){filters+='<span class="'+relClass+'">'+def.rel+"</span>"}}}filters+="</span>"}if(filters===""&&this.ifNoFilters){filters=this.ifNoFilters}if(filters!==""){var frag='<div class="'+containerClass+'">{{FILTERS}}</div>';frag=frag.replace(/{{FILTERS}}/g,filters);sf.context.html(frag);var removeSelector=edges.css_class_selector(ns,"remove",this);edges.on(removeSelector,"click",this,"removeFilter")}else{sf.context.html("")}};this.removeFilter=function(element){var el=this.component.jq(element);var field=el.attr("data-field");var ft=el.attr("data-filter");var bool=el.attr("data-bool");var value=false;if(ft==="terms"||ft==="term"){value=el.attr("data-value")}else if(ft==="range"){value={};var from=el.attr("data-gte");var fromType="gte";if(!from){from=el.attr("data-gt");fromType="gt"}var to=el.attr("data-lt");var toType="lt";if(!to){to=el.attr("data-lte");toType="lte"}if(from){value["from"]=parseInt(from);value["fromType"]=fromType}if(to){value["to"]=parseInt(to);value["toType"]=toType}}this.component.removeFilter(bool,ft,field,value)}}}});
$.extend(edges,{numbers:{newImportantNumbers:function(params){return edges.instantiate(edges.numbers.ImportantNumbers,params,edges.newComponent)},ImportantNumbers:function(params){this.main=edges.getParam(params.main,false);this.second=edges.getParam(params.second,false);this.calculate=edges.getParam(params.calculate,false);this.synchronise=function(){if(this.calculate!==false){var values=this.calculate(this);this.main=values.main;this.second=values.second}}},newStory:function(params){return edges.instantiate(edges.numbers.Story,params,edges.newComponent)},Story:function(params){this.template=edges.getParam(params.template,false);this.values=edges.getParam(params.values,{});this.calculate=edges.getParam(params.calculate,false);this.synchronise=function(){if(this.calculate!==false){this.values=this.calculate(this)}}}}});
$.extend(edges,{nvd3:{DataSeriesConversions:{toXY:function(data_series){var new_series=[];for(var i=0;i<data_series.length;i++){var os=data_series[i];var ns={};ns["key"]=os["key"];ns["values"]=[];for(var j=0;j<os.values.length;j++){var vector=os.values[j];ns["values"].push({x:vector.label,y:vector.value})}new_series.push(ns)}return new_series}},tools:{persistingPieColour:function(colours,persistence){if(!colours){colours=["#ea6ccb","#8fc8b0","#a9cf85","#d90d4c","#6c537e","#64d54f","#ecc7c4","#f1712b"]}if(!persistence){persistence={}}var i=0;return function(d,x){if(d.label in persistence){return persistence[d.label]}else{var c=colours[i%(colours.length-1)];i++;persistence[d.label]=c;return c}}},hasData:function(dataSeries){if(!dataSeries){return false}if(dataSeries.length==0){return false}var emptyCount=0;for(var i=0;i<dataSeries.length;i++){var series=dataSeries[i];if(series.values.length==0){emptyCount++}}if(emptyCount==dataSeries.length){return false}return true},wrapLabels:function(params){var axisSelector=params.axisSelector;var maxWidth=params.maxWidth;var maxHeight=params.maxHeight;var lineHeight=params.lineHeight||1.2;var wordBreaks=params.wordBreaks||[" ","\t"];var minChunkSize=params.minHyphenSize||3;function _isMidWord(currentLine,remainder){var leftChar=$.inArray(currentLine[currentLine.length-1],wordBreaks)===-1;var rightChar=$.inArray(remainder[0],wordBreaks)===-1;return leftChar&&rightChar}function _toPrevSpace(currentLine){for(var i=currentLine.length-1;i>=0;i--){var char=currentLine[i];if($.inArray(char,wordBreaks)!==-1){return currentLine.length-i}}return-1}function _toNextSpace(remainder){for(var i=0;i<remainder.length;i++){var char=remainder[i];if($.inArray(char,wordBreaks)!==-1){return i+1}}return-1}function _backtrack(count,currentLine,remainder){for(var i=0;i<count;i++){remainder.unshift(currentLine.pop())}}function _isTooLong(tspan){return tspan.node().getComputedTextLength()>=maxWidth}function separate(text){var chars=text.text().trim().split("");text.text(null);var lines=[];var x=text.attr("x");var tspan=text.append("tspan").attr("x",x).attr("y",0);var currentLine=[];while(chars.length>0){var char=chars.shift();currentLine.push(char);tspan.text(currentLine.join(""));var maxed=false;var hyphenated=false;while(_isTooLong(tspan)){maxed=true;if(hyphenated){currentLine.splice(currentLine.length-1);hyphenated=false}_backtrack(1,currentLine,chars);if(_isMidWord(currentLine,chars)){var toPrevSpace=_toPrevSpace(currentLine);if(toPrevSpace===-1||toPrevSpace-1>minChunkSize){_backtrack(1,currentLine,chars);currentLine.push("-");hyphenated=true}else{_backtrack(toPrevSpace,currentLine,chars)}}currentLine=currentLine.join("").trim().split("");tspan.text(currentLine.join(""))}if(!maxed&&chars.length>0){continue}if(maxed||chars.length===0){lines.push(currentLine);currentLine=[]}}tspan.remove();var tspans=[];for(var i=0;i<lines.length;i++){tspan=text.append("tspan").attr("x",x).attr("y",0);tspan.text(lines[i].join(""));tspans.push(tspan)}return tspans}function distribute(text,tspans){var imax=tspans.length;var pmax=lineHeight*(imax-1);var dy=parseFloat(text.attr("dy"));for(var j=0;j<tspans.length;j++){var pos=lineHeight*j-pmax/2+dy;var tspan=tspans[j];tspan.attr("dy",pos+"em")}}function reduce(text,tspans){var reduced=false;var box=text.node().getBBox();if(box.height>maxHeight&&tspans.length>1){tspans[tspans.length-1].remove();tspans.pop();var line=tspans[tspans.length-1].text();if(line.length>3){line=line.substring(0,line.length-3)+"..."}tspans[tspans.length-1].text(line);reduced=true}return reduced}d3.selectAll(axisSelector+" .tick text").each(function(i,e){var text=d3.select(this);var tspans=separate(text);do{distribute(text,tspans)}while(reduce(text,tspans))})}},newPieChartRenderer:function(params){if(!params){params={}}edges.nvd3.PieChartRenderer.prototype=edges.newRenderer(params);return new edges.nvd3.PieChartRenderer(params)},PieChartRenderer:function(params){this.showLegend=edges.getParam(params.showLegend,true);this.showLabels=edges.getParam(params.showLabels,true);this.donut=edges.getParam(params.donut,false);this.labelThreshold=params.labelThreshold||.05;this.transitionDuration=params.transitionDuration||500;this.noDataMessage=params.noDataMessage||false;this.color=params.color||false;this.legendPosition=params.legendPosition||"top";this.labelsOutside=edges.getParam(params.labelsOutside,false);this.showLabels=edges.getParam(params.showLabels,true);this.valueFormat=params.valueFormat||false;this.marginTop=edges.getParam(params.marginTop,30);this.marginRight=edges.getParam(params.marginRight,30);this.marginBottom=edges.getParam(params.marginBottom,30);this.marginLeft=edges.getParam(params.marginLeft,30);this.onResize=edges.getParam(params.onResize,false);this.resizeOnInit=edges.getParam(params.resizeOnInit,false);this.footer=edges.getParam(params.footer,false);this.growOnHover=edges.getParam(params.growOnHover,true);this.namespace="edges-nvd3-pie";this.draw=function(){var containerClass=edges.css_classes(this.namespace,"container",this);var displayClasses=edges.css_classes(this.namespace,"display",this);var svgContainerClasses=edges.css_classes(this.namespace,"svg-container",this);var displayFrag="";if(this.component.display){displayFrag='<div class="'+displayClasses+'">'+this.component.display+"</div>"}var footerFrag="";if(this.footer){var val=this.footer;if(typeof this.footer==="function"){val=this.footer(this)}var footerClasses=edges.css_classes(this.namespace,"footer",this);footerFrag='<div class="'+footerClasses+'">'+val+"</div>"}var svgId=edges.css_id(this.namespace,"svg",this);var svgSelector=edges.css_id_selector(this.namespace,"svg",this);var frag='<div class="'+containerClass+'">                        '+displayFrag+'                        <div class="'+svgContainerClasses+'"><svg id="'+svgId+'"></svg></div>                        '+footerFrag+"                    </div>";this.component.context.html(frag);var data_series=this.component.dataSeries;if(!data_series){data_series=[]}if(data_series.length>0){data_series=data_series[0].values}else{data_series=[]}var outer=this;nv.addGraph(function(){var chart=nv.models.pieChart().x(function(d){return d.label}).y(function(d){return d.value}).showLabels(outer.showLabels).legendPosition(outer.legendPosition).labelsOutside(outer.labelsOutside).margin({left:outer.marginLeft,right:outer.marginRight,top:outer.marginTop,bottom:outer.marginBottom}).showLegend(outer.showLegend).showLabels(outer.showLabels).growOnHover(outer.growOnHover);if(outer.noDataMessage){chart.noData(outer.noDataMessage)}if(outer.color){chart.color(outer.color)}if(outer.valueFormat){chart.valueFormat(outer.valueFormat)}d3.select(svgSelector).datum(data_series).transition().duration(outer.transitionDuration).call(chart);if(outer.onResize){var resizeFn=function(){outer.onResize(chart);chart.update()};if(outer.resizeOnInit){resizeFn()}nv.utils.windowResize(resizeFn)}else{nv.utils.windowResize(chart.update)}return chart})}},newHorizontalMultibarRenderer:function(params){if(!params){params={}}edges.nvd3.HorizontalMultibarRenderer.prototype=edges.newRenderer(params);return new edges.nvd3.HorizontalMultibarRenderer(params)},HorizontalMultibarRenderer:function(params){this.title=edges.getParam(params.title,false);this.showValues=edges.getParam(params.showValues,true);this.toolTips=edges.getParam(params.toolTips,true);this.controls=edges.getParam(params.controls,false);this.stacked=edges.getParam(params.stacked,false);this.legend=edges.getParam(params.legend,true);this.color=params.color||false;this.noDataMessage=edges.getParam(params.noDataMessage,false);this.transitionDuration=params.transitionDuration||500;this.marginTop=edges.getParam(params.marginTop,30);this.marginRight=edges.getParam(params.marginRight,50);this.marginBottom=edges.getParam(params.marginBottom,50);this.marginLeft=edges.getParam(params.marginLeft,200);this.yTickFormat=edges.getParam(params.yTickFormat,",.0f");this.xTickFormat=edges.getParam(params.xTickFormat,false);this.valueFormat=edges.getParam(params.valueFormat,false);this.xAxisLabel=edges.getParam(params.xAxisLabel,false);this.yAxisLabel=edges.getParam(params.yAxisLabel,false);this.xAxisLabelWrap=edges.getParam(params.xAxisLabelWrap,false);this.tooltipGenerator=edges.getParam(params.tooltipGenerator,false);this.dynamicHeight=edges.getParam(params.dynamicHeight,false);this.barHeight=edges.getParam(params.barHeight,0);this.reserveAbove=edges.getParam(params.reserveAbove,0);this.reserveBelow=edges.getParam(params.reserveBelow,0);this.groupSpacing=edges.getParam(params.groupSpacing,false);this.hideIfNoData=edges.getParam(params.hideIfNoData,false);this.onHide=edges.getParam(params.onHide,false);this.onShow=edges.getParam(params.onShow,false);this.namespace="edges-nvd3-horizontal-multibar";this.draw=function(){$(".nvtooltip").remove();var data_series=this.component.dataSeries;if(!data_series){data_series=[]}if(this.hideIfNoData){if(!edges.nvd3.tools.hasData(data_series)){this.component.context.html("");this.component.context.hide();if(this.onHide){this.onHide()}return}}this.component.context.show();if(this.onShow){this.onShow()}var customAttributes="";if(this.dynamicHeight){var seriesCount=0;for(var i=0;i<data_series.length;i++){var series=data_series[i];if(series.values.length>seriesCount){seriesCount=series.values.length}}var height=this.reserveAbove+this.reserveBelow+seriesCount*this.barHeight;customAttributes='style="height:'+height+'px"'}var title="";if(this.title!==false){title=this.title}var svgId=edges.css_id(this.namespace,"svg",this);var svgSelector=edges.css_id_selector(this.namespace,"svg",this);this.component.context.html(title+"<div "+customAttributes+'><svg id="'+svgId+'"></svg></div>');var that=this;nv.addGraph(function(){var chart=nv.models.multiBarHorizontalChart().x(function(d){return d.label}).y(function(d){return d.value}).margin({top:that.marginTop,right:that.marginRight,bottom:that.marginBottom,left:that.marginLeft}).showValues(that.showValues).tooltips(that.toolTips).showControls(that.controls).showLegend(that.legend);if(that.stacked){chart.multibar.stacked(that.stacked)}if(that.yTickFormat){var fn=that.yTickFormat;if(typeof that.yTickFormat==="string"){fn=d3.format(that.yTickFormat)}chart.yAxis.tickFormat(fn)}if(that.yAxisLabel){chart.yAxis.axisLabel(that.yAxisLabel)}if(that.xTickFormat){var fn=that.xTickFormat;if(typeof that.xTickFormat==="string"){fn=d3.format(that.xTickFormat)}chart.xAxis.tickFormat(fn)}if(that.xAxisLabel){chart.xAxis.axisLabel(that.xAxisLabel)}if(that.valueFormat){var fn=that.valueFormat;if(typeof that.valueFormat==="string"){fn=d3.format(that.xTickFormat)}chart.valueFormat(fn);chart.tooltip.valueFormatter(fn)}if(that.noDataMessage){chart.noData(that.noDataMessage)}if(that.color){chart.color(that.color)}if(that.tooltipGenerator){chart.tooltip.contentGenerator(that.tooltipGenerator)}if(that.groupSpacing){chart.groupSpacing(that.groupSpacing)}d3.select(svgSelector).datum(data_series).transition().duration(that.transitionDuration).call(chart);if(that.xAxisLabelWrap){edges.nvd3.tools.wrapLabels({axisSelector:svgSelector+" .nv-x.nv-axis",maxWidth:that.marginLeft-5,maxHeight:that.barHeight})}function updateChart(){chart.update();if(that.xAxisLabelWrap){edges.nvd3.tools.wrapLabels({axisSelector:svgSelector+" .nv-x.nv-axis",maxWidth:that.marginLeft-5,maxHeight:that.barHeight})}}nv.utils.windowResize(updateChart);return chart})}},newMultibarRenderer:function(params){if(!params){params={}}edges.nvd3.MultibarRenderer.prototype=edges.newRenderer(params);return new edges.nvd3.MultibarRenderer(params)},MultibarRenderer:function(params){this.xTickFormat=params.xTickFormat||",.2f";this.yTickFormat=params.yTickFormat||",.2f";this.transitionDuration=params.transitionDuration||500;this.controls=edges.getParam(params.controls,false);this.barColor=params.barColor||false;this.showLegend=edges.getParam(params.showLegend,true);this.xAxisLabel=params.xAxisLabel||"";this.yAxisLabel=params.yAxisLabel||"";this.yAxisLabelDistance=edges.getParam(params.yAxisLabelDistance,0);this.marginTop=edges.getParam(params.marginTop,30);this.marginRight=edges.getParam(params.marginRight,20);this.marginBottom=edges.getParam(params.marginBottom,50);this.marginLeft=edges.getParam(params.marginLeft,60);this.hideIfNoData=edges.getParam(params.hideIfNoData,false);this.onHide=edges.getParam(params.onHide,false);this.onShow=edges.getParam(params.onShow,false);this.namespace="edges-nvd3-multibar";this.draw=function(){var data_series=this.component.dataSeries;if(!data_series){data_series=[]}data_series=edges.nvd3.DataSeriesConversions.toXY(this.component.dataSeries);if(this.hideIfNoData){if(!edges.nvd3.tools.hasData(data_series)){this.component.context.html("");this.component.context.hide();if(this.onHide){this.onHide()}return}}this.component.context.show();if(this.onShow){this.onShow()}var displayClasses=edges.css_classes(this.namespace,"display",this);var displayFrag="";if(this.component.display){displayFrag='<span class="'+displayClasses+'">'+this.component.display+"</span><br>"}var svgId=edges.css_id(this.namespace,"svg",this);var svgSelector=edges.css_id_selector(this.namespace,"svg",this);this.component.context.html(displayFrag+'<svg id="'+svgId+'"></svg>');var outer=this;nv.addGraph(function(){var chart=nv.models.multiBarChart().showControls(outer.controls).margin({top:outer.marginTop,right:outer.marginRight,bottom:outer.marginBottom,left:outer.marginLeft});chart.xAxis.axisLabel(outer.xAxisLabel).tickFormat(d3.format(outer.xTickFormat));chart.yAxis.axisLabel(outer.yAxisLabel).tickFormat(d3.format(outer.yTickFormat)).axisLabelDistance(outer.yAxisLabelDistance);if(outer.barColor){chart.barColor(outer.barColor)}chart.showLegend(outer.showLegend);d3.select(svgSelector).datum(data_series).transition().duration(outer.transitionDuration).call(chart);nv.utils.windowResize(chart.update);return chart})}},newSimpleLineChartRenderer:function(params){if(!params){params={}}edges.nvd3.SimpleLineChartRenderer.prototype=edges.newRenderer(params);return new edges.nvd3.SimpleLineChartRenderer(params)},SimpleLineChartRenderer:function(params){this.interactiveGuideline=params.interactiveGuideline||true;this.xTickFormat=params.xTickFormat||",.2f";this.yTickFormat=params.yTickFormat||",.2f";this.transitionDuration=params.transitionDuration||500;this.lineColor=params.lineColor||false;this.includeOnY=edges.getParam(params.includeOnY,false);this.showLegend=edges.getParam(params.showLegend,true);this.xAxisLabel=params.xAxisLabel||"";this.yAxisLabel=params.yAxisLabel||"";this.yAxisLabelDistance=edges.getParam(params.yAxisLabelDistance,0);this.marginTop=edges.getParam(params.marginTop,30);this.marginRight=edges.getParam(params.marginRight,20);this.marginBottom=edges.getParam(params.marginBottom,50);this.marginLeft=edges.getParam(params.marginLeft,60);this.namespace="edges-nvd3-simple-line-chart";this.draw=function(){var displayClasses=edges.css_classes(this.namespace,"display",this);var displayFrag="";if(this.component.display){displayFrag='<span class="'+displayClasses+'">'+this.component.display+"</span><br>"}var svgId=edges.css_id(this.namespace,"svg",this);var svgSelector=edges.css_id_selector(this.namespace,"svg",this);this.component.context.html(displayFrag+'<svg id="'+svgId+'"></svg>');var data_series=this.component.dataSeries;if(!data_series){data_series=[]}var ds=edges.nvd3.DataSeriesConversions.toXY(data_series);var outer=this;nv.addGraph(function(){var chart=nv.models.lineChart().useInteractiveGuideline(outer.interactiveGuideline).margin({top:outer.marginTop,right:outer.marginRight,bottom:outer.marginBottom,left:outer.marginLeft});chart.xAxis.axisLabel(outer.xAxisLabel).tickFormat(d3.format(outer.xTickFormat));if(outer.lineColor){chart.color(outer.lineColor)}if(outer.includeOnY!==false){chart.forceY(outer.includeOnY)}chart.yAxis.axisLabel(outer.yAxisLabel).tickFormat(d3.format(outer.yTickFormat)).axisLabelDistance(outer.yAxisLabelDistance);chart.showLegend(outer.showLegend);d3.select(svgSelector).datum(ds).transition().duration(outer.transitionDuration).call(chart);nv.utils.windowResize(chart.update);return chart})}}}});
$.extend(true,edges,{bs3:{newTabularResultsRenderer:function(params){if(!params){params={}}edges.bs3.TabularResultsRenderer.prototype=edges.newRenderer(params);return new edges.bs3.TabularResultsRenderer(params)},TabularResultsRenderer:function(params){this.title=edges.getParam(params.title,false);this.noResultsText=params.noResultsText||"No results to display";this.hideOnNoResults=edges.getParam(params.hideOnNoResults,false);this.defaultCellContent=params.defaultCellContent||"-";this.fieldDisplay=params.fieldDisplay||[];this.displayListedOnly=edges.getParam(params.displayListedOnly,true);this.headerOrderingFunction=edges.getParam(params.headerOrderingFunction,false);this.sortable=edges.getParam(params.sortable,false);this.download=edges.getParam(params.download,false);this.downloadText=edges.getParam(params.downloadText,"download");this.downloadPrefix=edges.getParam(params.downloadPrefix,"download");this.namespace="edges-bs3-tabular-results";this.draw=function(){var title="";if(this.title!==false){title=this.title}var frag="";if(this.component.results===false||this.component.results.length===0){if(this.hideOnNoResults){return}else{var noResultsClass=edges.css_classes(this.namespace,"no-results",this);frag='<div class="row"><div class="col-md-12">'+title+'<div class="'+noResultsClass+'">'+this.noResultsText+"</div></div></div>";this.component.context.html(frag)}}else{var results=this.component.results;var headerKeys=this._getHeaderRow();var tableClasses=edges.css_classes(this.namespace,"table",this);var headerClasses=edges.css_classes(this.namespace,"header",this);var cellClasses=edges.css_classes(this.namespace,"cell",this);var downloadClasses=edges.css_classes(this.namespace,"download",this);var tableDivClasses=edges.css_classes(this.namespace,"tablediv",this);var downloadId=edges.css_id(this.namespace,"download",this);var down="";if(this.download){down='<div class="row"><div class="col-md-12"><div class="'+downloadClasses+'"><a href="#" id="'+downloadId+'">'+edges.escapeHtml(this.downloadText)+"</a></div></div></div>"}frag=title+'<div class="table-responsive '+tableDivClasses+'">';frag+='<table class="'+tableClasses+'"><thead><tr>_HEADERS_</tr></thead><tbody>';var headerDisplay=[];for(var i=0;i<headerKeys.length;i++){var trip=false;for(var j=0;j<this.fieldDisplay.length;j++){var fd=this._getFieldDisplay(headerKeys[i]);if(fd){headerDisplay.push(fd.display);trip=true;break}}if(!trip){headerDisplay.push(headerKeys[i])}}var headers="";for(var i=0;i<headerDisplay.length;i++){var header=headerDisplay[i];var headerFieldClasses=edges.css_classes(this.namespace,"header-"+edges.safeId(header),this);headers+='<th class="'+headerClasses+" "+headerFieldClasses+'">'+header+"</th>"}frag=frag.replace(/_HEADERS_/g,headers);for(var i=0;i<results.length;i++){var res=results[i];frag+="<tr>";for(var j=0;j<headerKeys.length;j++){var key=headerKeys[j];var def=this.defaultCellContent;var fd=this._getFieldDisplay(key);if(fd&&fd.default){def=fd.default}var val="";if(fd.fieldFunction){val=fd.fieldFunction({result:res,default:def})}else{val=edges.objVal(key,res,def)}if(fd.valueFunction){val=fd.valueFunction(val,res)}else{val=edges.escapeHtml(val)}var fieldClasses=edges.css_classes(this.namespace,"cell-"+edges.safeId(key),this);frag+='<td class="'+cellClasses+" "+fieldClasses+'">'+val+"</td>"}frag+="</tr>"}frag+="</tbody></table></div>"+down;this.component.context.html(frag);if(this.sortable){var tableSelector=edges.css_class_selector(this.namespace,"table",this);var jqTable=this.component.context.find(tableSelector);jqTable.tablesorter()}if(this.download){var downloadIdSelector=edges.css_id_selector(this.namespace,"download",this);edges.on(downloadIdSelector,"click",this,"doDownload")}}};this.doDownload=function(element){if(!this.download){return}var downloadInfo=this._downloadData();var blob=new Blob([downloadInfo.data],{type:downloadInfo.fileType});var url=window.URL.createObjectURL(blob);var a=document.createElement("a");document.body.appendChild(a);a.style="display: none";a.href=url;a.download=downloadInfo.fileName;a.click();window.URL.revokeObjectURL(url)};this._downloadData=function(){if(!this.download){return false}var table=[];var results=this.component.results;if(results&&results.length>0){var headerKeys=this._getHeaderRow();var headerDisplay=[];for(var i=0;i<headerKeys.length;i++){var trip=false;for(var j=0;j<this.fieldDisplay.length;j++){var fd=this._getFieldDisplay(headerKeys[i]);if(fd){headerDisplay.push(fd.display);trip=true;break}}if(!trip){headerDisplay.push(headerKeys[i])}}table.push(headerDisplay);for(var i=0;i<results.length;i++){var res=results[i];var row=[];for(var j=0;j<headerKeys.length;j++){var key=headerKeys[j];var val=edges.objVal(key,res,"");row.push(val)}table.push(row)}}var data=edges.csv.serialise({data:table});var fileType="text/csv;charset=UTF-8";var extension="csv";var stamp=(new Date).getTime();var fileName=this.downloadPrefix+"_"+stamp+"."+extension;return{data:data,fileType:fileType,fileName:fileName}};this._getFieldDisplay=function(field){for(var j=0;j<this.fieldDisplay.length;j++){if(this.fieldDisplay[j].field==field){return this.fieldDisplay[j]}}return false};this._getHeaderRow=function(){if(this.headerOrderingFunction){return this.headerOrderingFunction(this)}var results=this.component.results;var hasResults=results!==false&&results.length>0;if(!hasResults||this.fieldDisplay.length==0&&this.displayListedOnly){return[]}var headers=[];if(this.fieldDisplay.length>0){for(var i=0;i<this.fieldDisplay.length;i++){headers.push(this.fieldDisplay[i].field)}}if(!this.displayListedOnly){var keySet={};for(var i=0;i<results.length;i++){var ks=Object.keys(results[i]);for(var j=0;j<ks.length;j++){if(!(ks[j]in keySet)){keySet[ks[j]]=true}}}var keys=Object.keys(keySet);keys.sort();for(var i=0;i<keys.length;i++){if($.inArray(keys[i],headers)==-1){headers.push(keys[i])}}}return headers}}}});
$.extend(edges,{newStaticDataGrid:function(params){if(!params){params={}}edges.StaticDataGrid.prototype=edges.newComponent(params);return new edges.StaticDataGrid(params)},StaticDataGrid:function(params){this.resourceId=edges.getParam(params.resourceId,false);this.results=[];this.synchronise=function(){this.results=[];var resource=this.edge.resources[this.resourceId];var iter=resource.iterator();var res=iter.next();while(res){this.results.push(res);res=iter.next()}}},newStaticDataSelector:function(params){if(!params){params={}}edges.StaticDataSelector.prototype=edges.newComponent(params);return new edges.StaticDataSelector(params)},StaticDataSelector:function(params){this.resourceId=edges.getParam(params.resourceId,false);this.filterResourceIds=edges.getParam(params.filterResourceIds,[this.resourceId]);this.field=edges.getParam(params.field,false);this.display=edges.getParam(params.display,"Untitled");this.filters=[];this.selected=[];this.values=[];this.terms=[];this.synchronise=function(){this.filters=[];this.selected=[];this.values=[];this.terms=[];var resource=this.edge.resources[this.resourceId];var terms=resource.aggregation({agg:{terms:this.field},filtered:false});for(var i=0;i<terms.length;i++){var term=terms[i];if(term.term===""){continue}this.values.push({term:term.term,display:term.term,count:term.count});this.terms.push({term:term.term,display:term.term,count:term.count})}for(var i=0;i<resource.filters.length;i++){var filt=resource.filters[i];var field=filt.field;if(field===this.field){var val=filt.value;this.filters.push({term:val,display:val});this.selected.push(val)}}};this.selectTerm=function(term){var filter={field:this.field,type:"exact",value:term};for(var i=0;i<this.filterResourceIds.length;i++){var resourceId=this.filterResourceIds[i];this.edge.resources[resourceId].add_filter({filter:filter})}this.edge.cycle()};this.removeFilter=function(term){var filter=false;if(!term){filter={field:this.field}}else{filter={field:this.field,type:"exact",value:term}}for(var i=0;i<this.filterResourceIds.length;i++){var resourceId=this.filterResourceIds[i];this.edge.resources[resourceId].clear_filter({filter:filter})}this.edge.cycle()};this.selectTerms=function(params){var terms=params.terms;this.removeFilter();this.selectTerm(terms[0]);return true};this.changeSize=function(size){};this.changeSort=function(sortBy,sortDir){}},newAggregateTable:function(params){return edges.instantiate(edges.AggregateTable,params,edges.newComponent)},AggregateTable:function(params){this.aggregateAround=edges.getParam(params.aggregateAround,false);this.sort=edges.getParam(params.sort,false);this.limit=edges.getParam(params.limit,false);this.splitFieldsOn=edges.getParam(params.splitFieldsOn,false);this.namespace="edges-aggregate-table";this.results=[];this.synchronise=function(edge){this.results=[];var source=this.edge.result;if(!source){return}var agg=source.aggregation(this.aggregateAround);for(var i=0;i<agg.buckets.length;i++){var bucket=agg.buckets[i];var obj={};var keys=Object.keys(bucket);for(var j=0;j<keys.length;j++){var key=keys[j];var val=bucket[key];if(key==="key"){obj[this.aggregateAround]=val}else if(key==="doc_count"){obj["doc_count"]=val}else{obj[key]=val.value}}this.results.push(obj)}if(this.sort){this.results.sort(this.sort)}if(this.limit!==false){this.results=this.results.slice(0,this.limit)}this._restructure()};this._restructure=function(){if(this.splitFieldsOn===false){return}var newResults=[];for(var k=0;k<this.results.length;k++){var result=this.results[k];var newResult={};var keys=Object.keys(result);for(var i=0;i<keys.length;i++){var key=keys[i];var val=result[key];var bits=key.split(this.splitFieldsOn);var context=newResult;for(var j=0;j<bits.length;j++){var bit=bits[j];if(!context.hasOwnProperty(bit)){if(j===bits.length-1){context[bit]=val}else{context[bit]={};context=context[bit]}}else{context=context[bit]}}}newResults.push(newResult)}this.results=newResults}}});
var widget={activeEdge:false,formatters:{year:function(params){return function(val){var d=new Date(val);if(isNaN(d.getTime())){return val}return d.getUTCFullYear()}},year_month:function(params){var formatter=edges.numFormat({reflectNonNumbers:true,zeroPadding:2});return function(val){var d=new Date(val);if(isNaN(d.getTime())){return val}return d.getUTCFullYear()+"-"+formatter(d.getUTCMonth()+1)}},full_date:function(params){return function(val){return val}},number:function(params){var formatter=edges.numFormat({reflectNonNumbers:true,thousandsSeparator:","});return function(val){return formatter(val)}},country_link:function(params){var urlTemplate=params.settings.countryPageTemplate;return function(val){var url=urlTemplate.replace("{country}",encodeURIComponent(val));return'<a href="'+url+'">'+val+"</a>"}},reactor_link:function(params){var urlTemplate=params.settings.reactorPageTemplate;return function(val,res){var reactorId=res.id;var url=urlTemplate.replace("{reactor}",encodeURIComponent(reactorId));return'<a href="'+url+'">'+val+"</a>"}}},init:function(params){params.selector="#"+params.id+"-inner";var type=params.type;if(type==="highlight"){return widget.highlight(params)}else if(type==="chart_histogram"){return widget.chartHistogram(params)}else if(type==="table_reactor"){return widget.tableReactor(params)}else if(type==="chart_accumulator"){return widget.chartAccumulator(params)}else if(type==="table_aggregate"){return widget.tableAggregate(params)}else if(type==="chart_status"){return widget.chartStatus(params)}return false},newSingleComponentTemplate:function(params){return edges.instantiate(widget.SingleComponentTemplate,params,edges.newTemplate)},SingleComponentTemplate:function(params){this.namespace="widget-single";this.height=params.height||false;this.draw=function(edge){this.edge=edge;var containerClass=edges.css_classes(this.namespace,"container");var panel=this.edge.category("panel");var style="";if(this.height){style=' style="height: '+this.height+'px" '}var frag='<div class="'+containerClass+'"><div class="row">';frag+='<div class="col-md-12"><div id="'+panel[0].id+'" '+style+"></div></div></div></div>";edge.context.html(frag)}},newHighlightTemplate:function(params){return edges.instantiate(widget.HighlightTemplate,params,edges.newTemplate)},HighlightTemplate:function(params){this.namespace="widget-highlight";this.id=params.id;this.draw=function(edge){this.edge=edge;var containerClass=edges.css_classes(this.namespace,"container");var frag='<div class="row">                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">                    <div class="row">                        <div class="col-lg-8 col-lg-offset-4 col-md-8 col-md-offset-4 col-sm-8 col-sm-offset-4 col-xs-10 col-xs-offset-1">                            <div id="operable_reactors_count_'+this.id+'"></div>                        </div>                    </div>                </div>                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">                    <div class="row">                        <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-10 col-xs-offset-1">                            <div id="reactors_under_construction_count_'+this.id+'"></div>                        </div>                    </div>                </div>                <div class="col-lg-4 col-lg-offset-0 col-md-4 col-md-offset-0 col-sm-4 col-sm-offset-0 col-xs-10 col-xs-offset-1">                    <div class="row">                        <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">                            <div id="reactors_shutdown_count_'+this.id+'"></div>                        </div>                    </div>                </div>            </div>';var frag='<div class="'+containerClass+'">'+frag+"</div>";edge.context.html(frag)}},highlight:function(params){var selector=params.selector;var prefix=edges.getParam(params.prefix,"");var reactorsBackground=params.base+"/static/images/iconReactor.svg";var underConstructionBackground=params.base+"/static/images/iconConstruction.svg";var shutdownBackground=params.base+"/static/images/iconShutdown.svg";var openingQuery=es.newQuery({raw:params.query});openingQuery.size=0;openingQuery.from=0;openingQuery.addAggregation(es.newTermsAggregation({name:"status",field:"reactor.status.exact",aggs:[es.newSumAggregation({name:"total_gwe",field:"reactor.reference_unit_power_capacity_net"})]}));function resizeHandler(renderer){var container=renderer.component.context;var width=container.width();var oversized=false;if(width>180){width=180;oversized=true}var selector=edges.css_class_selector(renderer.namespace,"graphic",renderer);var graphic=container.find(selector);graphic.css("height",width+"px");if(oversized){graphic.addClass("oversized")}else{graphic.removeClass("oversized")}}var components=[];components.push(edges.numbers.newImportantNumbers({id:"operable_reactors_count_"+params.id,category:"big-number",calculate:widget._reactorStatusCount({status:"Operable"}),renderer:edges.bs3.newImportantNumbersRenderer({title:"<h4>Operable Reactors</h4>",backgroundImg:reactorsBackground,mainNumberFormat:edges.numFormat({decimalPlaces:0,thousandsSeparator:","}),secondNumberFormat:edges.numFormat({decimalPlaces:0,thousandsSeparator:",",suffix:" MWe"}),resizeHandler:resizeHandler})}),edges.numbers.newImportantNumbers({id:"reactors_under_construction_count_"+params.id,category:"big-number",calculate:widget._reactorStatusCount({status:"Under Construction"}),renderer:edges.bs3.newImportantNumbersRenderer({title:"<h4>Reactors&nbsp;Under Construction</h4>",backgroundImg:underConstructionBackground,mainNumberFormat:edges.numFormat({decimalPlaces:0,thousandsSeparator:","}),secondNumberFormat:edges.numFormat({decimalPlaces:0,thousandsSeparator:",",suffix:" MWe"}),resizeHandler:resizeHandler})}),edges.numbers.newImportantNumbers({id:"reactors_shutdown_count_"+params.id,category:"big-number",calculate:widget._reactorStatusCount({status:"Permanent Shutdown"}),renderer:edges.bs3.newImportantNumbersRenderer({title:"<h4>Reactors Shutdown</h4>",backgroundImg:shutdownBackground,mainNumberFormat:edges.numFormat({decimalPlaces:0,thousandsSeparator:","}),secondNumberFormat:edges.numFormat({decimalPlaces:0,thousandsSeparator:",",suffix:" MWe"}),resizeHandler:resizeHandler})}));var search_url=params.base+"/query/"+prefix+"reactor/_search";return edges.newEdge({selector:selector,template:widget.newHighlightTemplate({id:params.id}),search_url:search_url,manageUrl:false,openingQuery:openingQuery,components:components})},chartHistogram:function(params){var selector=params.selector;var prefix=edges.getParam(params.prefix,"");if(!params.hasOwnProperty("settings")){return}if(!params.settings.hasOwnProperty("start")||!params.settings.hasOwnProperty("end")||!params.settings.hasOwnProperty("value")||!params.settings.hasOwnProperty("label")||!params.settings.hasOwnProperty("height")||!params.settings.hasOwnProperty("chart")){return false}var openingQuery=es.newQuery({raw:params.query});openingQuery.size=1e4;openingQuery.from=0;var leftMargin=params.settings.left;if(!leftMargin){leftMargin=80}else{leftMargin=parseInt(leftMargin)}var labelDistance=params.settings.distance;if(!labelDistance){labelDistance=0}else{labelDistance=parseInt(labelDistance)}var components=[];if(params.settings.chart==="bar"){components.push(edges.newMultibar({id:"chart_histogram_"+params.id,category:"panel",dataFunction:widget._dataSeriesFromHistogram({seriesName:params.settings.label}),renderer:edges.nvd3.newMultibarRenderer({xTickFormat:".0f",barColor:["#1e9dd8"],yTickFormat:",.0f",showLegend:false,xAxisLabel:"Year",yAxisLabel:params.settings.label,marginLeft:leftMargin,yAxisLabelDistance:labelDistance})}))}else if(params.settings.chart==="line"){components.push(edges.newSimpleLineChart({id:"chart_histogram_"+params.id,category:"panel",dataFunction:widget._dataSeriesFromHistogram({seriesName:params.settings.label}),renderer:edges.nvd3.newSimpleLineChartRenderer({xTickFormat:".0f",lineColor:["#1e9dd8"],yTickFormat:",.0f",showLegend:false,xAxisLabel:"Year",yAxisLabel:params.settings.label,marginLeft:leftMargin,yAxisLabelDistance:labelDistance,includeOnY:0})}))}else{return false}var search_url=params.base+"/custom/"+prefix+"chart_histogram/_search?start="+params.settings.start+"&end="+params.settings.end+"&field="+params.settings.value;return edges.newEdge({selector:selector,template:widget.newSingleComponentTemplate({height:params.settings.height||false}),search_url:search_url,manageUrl:false,openingQuery:openingQuery,components:components})},chartAccumulator:function(params){var selector=params.selector;var prefix=edges.getParam(params.prefix,"");if(!params.hasOwnProperty("settings")){return}if(!params.settings.hasOwnProperty("start")||!params.settings.hasOwnProperty("end")||!params.settings.hasOwnProperty("value")||!params.settings.hasOwnProperty("label")||!params.settings.hasOwnProperty("height")||!params.settings.hasOwnProperty("chart")){return false}var openingQuery=es.newQuery({raw:params.query});openingQuery.size=1e4;openingQuery.from=0;openingQuery.setSourceFilters({include:["operation."+params.settings.value]});var leftMargin=params.settings.left;if(!leftMargin){leftMargin=80}else{leftMargin=parseInt(leftMargin)}var labelDistance=params.settings.distance;if(!labelDistance){labelDistance=0}else{labelDistance=parseInt(labelDistance)}var components=[];if(params.settings.chart==="bar"){components.push(edges.newMultibar({id:"chart_accumulator_"+params.id,category:"panel",dataFunction:widget._dataSeriesFromAccumulator({seriesName:params.settings.label,field:params.settings.value,start:params.settings.start,end:params.settings.end}),renderer:edges.nvd3.newMultibarRenderer({xTickFormat:".0f",barColor:["#1e9dd8"],yTickFormat:",.0f",showLegend:false,xAxisLabel:"Year",yAxisLabel:params.settings.label,marginLeft:leftMargin,yAxisLabelDistance:labelDistance})}))}else if(params.settings.chart==="line"){components.push(edges.newSimpleLineChart({id:"chart_accumulator_"+params.id,category:"panel",dataFunction:widget._dataSeriesFromAccumulator({seriesName:params.settings.label,field:params.settings.value,start:params.settings.start,end:params.settings.end}),renderer:edges.nvd3.newSimpleLineChartRenderer({xTickFormat:".0f",lineColor:["#1e9dd8"],yTickFormat:",.0f",showLegend:false,xAxisLabel:"Year",yAxisLabel:params.settings.label,marginLeft:leftMargin,yAxisLabelDistance:labelDistance,includeOnY:0})}))}else{return false}var search_url=params.base+"/query/"+prefix+"reactor/_search";return edges.newEdge({selector:selector,template:widget.newSingleComponentTemplate({height:params.settings.height||false}),search_url:search_url,manageUrl:false,openingQuery:openingQuery,components:components})},chartStatus:function(params){var selector=params.selector;var prefix=edges.getParam(params.prefix,"");if(!params.hasOwnProperty("settings")){return}if(!params.settings.hasOwnProperty("start")||!params.settings.hasOwnProperty("end")||!params.settings.hasOwnProperty("status")||!params.settings.hasOwnProperty("primary")||!params.settings.hasOwnProperty("label")||!params.settings.hasOwnProperty("height")||!params.settings.hasOwnProperty("chart")){return false}var openingQuery=es.newQuery({raw:params.query});openingQuery.size=1e4;openingQuery.from=0;var includes=widget._statusIncludeFields(params.settings);openingQuery.setSourceFilters({include:includes});var leftMargin=params.settings.left;if(!leftMargin){leftMargin=80}else{leftMargin=parseInt(leftMargin)}var labelDistance=params.settings.distance;if(!labelDistance){labelDistance=0}else{labelDistance=parseInt(labelDistance)}var components=[];if(params.settings.chart==="bar"){components.push(edges.newMultibar({id:"chart_status_"+params.id,category:"panel",dataFunction:widget._dataSeriesFromStatus({seriesName:params.settings.label,status:params.settings.status,primary:params.settings.primary,fallback:params.settings.fallback,start:params.settings.start,end:params.settings.end}),renderer:edges.nvd3.newMultibarRenderer({xTickFormat:".0f",barColor:["#1e9dd8"],yTickFormat:",.0f",showLegend:false,xAxisLabel:"Year",yAxisLabel:params.settings.label,marginLeft:leftMargin,yAxisLabelDistance:labelDistance})}))}else if(params.settings.chart==="line"){components.push(edges.newSimpleLineChart({id:"chart_status_"+params.id,category:"panel",dataFunction:widget._dataSeriesFromStatus({seriesName:params.settings.label,status:params.settings.status,primary:params.settings.primary,fallback:params.settings.fallback,start:params.settings.start,end:params.settings.end}),renderer:edges.nvd3.newSimpleLineChartRenderer({xTickFormat:".0f",lineColor:["#1e9dd8"],yTickFormat:",.0f",showLegend:false,xAxisLabel:"Year",yAxisLabel:params.settings.label,marginLeft:leftMargin,yAxisLabelDistance:labelDistance,includeOnY:0})}))}else{return false}var search_url=params.base+"/query/"+prefix+"reactor/_search";return edges.newEdge({selector:selector,template:widget.newSingleComponentTemplate({height:params.settings.height||false}),search_url:search_url,manageUrl:false,openingQuery:openingQuery,components:components})},tableReactor:function(params){var selector=params.selector;var prefix=edges.getParam(params.prefix,"");if(!params.hasOwnProperty("settings")){return}if(!params.settings.hasOwnProperty("limit")||!params.settings.hasOwnProperty("order")||!params.settings.hasOwnProperty("reactor")){return false}if(!params.settings.order.hasOwnProperty("field")||params.settings.reactor.length===0){return false}for(var i=0;i<params.settings.reactor;i++){var reactorField=params.settings.reactor[i];if(!reactorField.hasOwnProperty("field")||!reactorField.hasOwnProperty("display")){return false}}var sortSuffix="";if(params.settings.order.hasOwnProperty("sort_type")){if(params.settings.order.sort_type==="exact"){sortSuffix=".exact"}}var openingQuery=es.newQuery({raw:params.query});openingQuery.size=parseInt(params.settings.limit);openingQuery.from=0;openingQuery.addSortBy(es.newSort({field:params.settings.order.field+sortSuffix,order:params.settings.order.dir}));openingQuery.addSourceFilters({include:["id"]});var fieldDisplay=[];for(var i=0;i<params.settings.reactor.length;i++){var fieldDef=params.settings.reactor[i];var obj={field:fieldDef.field,display:fieldDef.display};if(fieldDef.hasOwnProperty("formatting")){var fn=widget.formatters[fieldDef.formatting](params);obj.valueFunction=fn}fieldDisplay.push(obj);openingQuery.addSourceFilters({include:[obj.field]})}var components=[edges.newResultsDisplay({id:"results_table_"+params.id,category:"panel",renderer:edges.bs3.newTabularResultsRenderer({fieldDisplay:fieldDisplay})})];var search_url=params.base+"/query/"+prefix+"reactor/_search";return edges.newEdge({selector:selector,template:widget.newSingleComponentTemplate(),search_url:search_url,manageUrl:false,openingQuery:openingQuery,components:components})},tableAggregate:function(params){var selector=params.selector;var prefix=edges.getParam(params.prefix,"");if(!params.hasOwnProperty("settings")){return}if(!params.settings.hasOwnProperty("aggregate_around")||!params.settings.hasOwnProperty("order")||!params.settings.hasOwnProperty("aggregate_on")||!params.settings.hasOwnProperty("limit")){return false}if(!params.settings.aggregate_around.hasOwnProperty("field")||!params.settings.aggregate_around.hasOwnProperty("display")){return false}for(var i=0;i<params.settings.aggregate_on.length;i++){var aggField=params.settings.aggregate_on[i];if(!aggField.hasOwnProperty("field")||!aggField.hasOwnProperty("display")){return false}}var subaggs=[];for(var i=0;i<params.settings.aggregate_on.length;i++){var aggField=params.settings.aggregate_on[i];subaggs.push(es.newSumAggregation({name:aggField.field,field:aggField.field}))}var openingQuery=es.newQuery({raw:params.query});openingQuery.size=0;openingQuery.from=0;openingQuery.addAggregation(es.newTermsAggregation({name:params.settings.aggregate_around.field,field:params.settings.aggregate_around.field+".exact",size:1e4,aggs:subaggs}));var fieldDisplay=[];var aaObj={field:params.settings.aggregate_around.field,display:params.settings.aggregate_around.display};if(params.settings.aggregate_around.hasOwnProperty("formatting")){var fn=widget.formatters[params.settings.aggregate_around.formatting](params);aaObj.valueFunction=fn}fieldDisplay.push(aaObj);for(var i=0;i<params.settings.aggregate_on.length;i++){var fieldDef=params.settings.aggregate_on[i];var obj={field:fieldDef.field,display:fieldDef.display};if(fieldDef.hasOwnProperty("formatting")){var fn=widget.formatters[fieldDef.formatting](params);obj.valueFunction=fn}fieldDisplay.push(obj)}var components=[edges.newAggregateTable({id:"aggregate_table_"+params.id,category:"panel",limit:params.settings.limit,sort:function(a,b){var acomp=parseInt(a[params.settings.order]||0);var bcomp=parseInt(b[params.settings.order]||0);if(acomp<bcomp){return 1}if(acomp>bcomp){return-1}return 0},aggregateAround:params.settings.aggregate_around.field,splitFieldsOn:".",renderer:edges.bs3.newTabularResultsRenderer({fieldDisplay:fieldDisplay})})];var search_url=params.base+"/query/"+prefix+"reactor/_search";return edges.newEdge({selector:selector,template:widget.newSingleComponentTemplate(),search_url:search_url,manageUrl:false,openingQuery:openingQuery,components:components})},_reactorStatusCount:function(params){var status=params.status;return function(component){var result=component.edge.result;var statuses=result.aggregation("status");var main=0;var second=0;for(var i=0;i<statuses.buckets.length;i++){var bucket=statuses.buckets[i];if(bucket.key===status){main=bucket.doc_count;second=bucket.total_gwe.value}}return{main:main,second:second}}},_dataSeriesFromHistogram:function(params){var seriesName=params.seriesName;return function(component){var results=component.edge.result;var buckets=results.data.aggregations.chart_histogram.buckets;var values=[];for(var i=0;i<buckets.length;i++){var bucket=buckets[i];var gen=bucket.summation.value;values.push({label:bucket.key,value:gen})}return[{key:seriesName,values:values}]}},_dataSeriesFromAccumulator:function(params){var seriesName=params.seriesName;var start=parseInt(params.start);var end=parseInt(params.end);return function(component){var results=component.edge.result.results();var accumulator={};for(var s=parseInt(start);s<=parseInt(end)&&s<=(new Date).getUTCFullYear();s++){accumulator[s]=0}for(var i=0;i<results.length;i++){var result=results[i];var field="operation."+params.field;var fieldData=edges.objVal(field,result);var years=Object.keys(accumulator);years.sort();var cumulation=0;for(var j=0;j<years.length;j++){var year=years[j];var val=fieldData[String(year)];if(val){cumulation+=val}accumulator[year]+=cumulation}}var values=[];for(var year in accumulator){values.push({label:year,value:accumulator[year]})}values.sort(function(a,b){if(parseInt(a.year)<parseInt(b.year)){return 1}if(parseInt(a.year)>parseInt(b.year)){return-1}return 0});if(values.length>0){var lastVal=values[values.length-1].value;var limit=values.length;for(var i=values.length-2;i>-1;i--){var val=values[i].value;if(val===lastVal){limit--}else{break}}values.splice(limit)}return[{key:seriesName,values:values}]}},_dataSeriesFromStatus:function(params){var seriesName=params.seriesName;var status=params.status;var primary=params.primary;var fallback=params.fallback;var start=parseInt(params.start);var end=parseInt(params.end);return function(component){var results=component.edge.result.results();var histogram={};for(var s=parseInt(start);s<=parseInt(end)&&s<=(new Date).getUTCFullYear();s++){histogram[s]=0}for(var i=0;i<results.length;i++){var reactor=results[i];if(!reactor.hasOwnProperty("reactor")){reactor.reactor={}}var years=[];var possibleYears=Object.keys(reactor.operation.operational_status);for(var j=0;j<possibleYears.length;j++){var possible=possibleYears[j];var yearStatus=reactor.operation.operational_status[possible];if(yearStatus===status){years.push(possible)}}if(primary==="reactor_count"){for(var j=0;j<years.length;j++){var year=years[j];if(histogram.hasOwnProperty(year)){histogram[year]+=1}}}else if(primary.substring(0,11)==="operational"){var opsField=primary.substring(12);var opsData={};if(reactor.operation.hasOwnProperty(opsField)){opsData=reactor.operation[opsField]}var fbVal=false;if(fallback&&reactor.reactor.hasOwnProperty(fallback)){var fbVal=reactor.reactor[fallback]}for(var j=0;j<years.length;j++){var year=years[j];if(!histogram.hasOwnProperty(year)){continue}var wasSet=false;if(opsData.hasOwnProperty(year)){var val=opsData[year];if(val!==0){histogram[year]+=val;wasSet=true}}if(!wasSet&&fbVal){histogram[year]+=fbVal}}}else{if(reactor.reactor.hasOwnProperty(primary)){var val=reactor.reactor[primary];for(var j=0;j<years.length;j++){var year=years[j];if(histogram.hasOwnProperty(year)){histogram[year]+=val}}}}}var values=[];for(var year in histogram){values.push({label:year,value:histogram[year]})}values.sort(function(a,b){if(parseInt(a.year)<parseInt(b.year)){return 1}if(parseInt(a.year)>parseInt(b.year)){return-1}return 0});if(values.length>0){var limit=values.length;for(var i=values.length-1;i>-1;i--){var val=values[i].value;if(val===0){limit--}else{break}}values.splice(limit)}return[{key:seriesName,values:values}]}},_statusIncludeFields:function(params){var primary=params.primary;var fallback=params.fallback;var include=["operation.operational_status"];if(primary.substring(0,11)==="operational"){var field=primary.substring(12);include.push("operation."+field)}else{include.push("reactor."+primary)}if(fallback){include.push("reactor."+fallback)}return include}};
